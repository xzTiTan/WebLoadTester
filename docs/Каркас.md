# WebLoadTester — UI/UX каркас и взаимодействия (без стилей)
Версия: **v2.1 18.02.2026**

## Changelog (v2.1)
- Добавлено **готовое ТЗ для Codex** на реализацию нового UI по v2.0: файлы, порядок работ, запреты, критерии готовности.
- Добавлен «Definition of Done» для UI-рефактора и чек-лист ручной проверки.

---

## 0. Границы и цель
**Обсуждаем только UI/UX и пользовательские взаимодействия.**
- Без декоративных стилей: **никаких скруглений/цветов/теней/анимаций**.
- Разрешено только функциональное: **отступы, размеры, сетка, группировка, прокрутка, блокировки, порядок, подсказки, сообщения об ошибках**.
- Целевой экран: **22" Full HD (1920×1080)**.

---

## 1. Основная компоновка окна (IDE-layout)

### 1.0. Навигация «Группы → Модули» (принятое решение)
- **Группы** (семейства) выбираются **сверху** через Tabs:
  - UI тестирование
  - HTTP тестирование
  - Сеть и безопасность
  - Прогоны (History)
- **Модули** выбираются **слева** (LeftNav) как список модулей *только для выбранной группы*.

Почему так лучше (для FullHD 22" и инженерной утилиты):
- вкладки сверху — быстрый “переключатель контекста” (что тестируем),
- список слева — быстрый “переключатель инструмента” (какой модуль запускаем),
- центр — всегда форма настроек, без прыжков интерфейса.

Поведение:
- Переключение Tabs **меняет состав** списка модулей слева.
- Для каждой вкладки запоминаем «последний выбранный модуль».
- Во время Running: верхние **Tabs доступны для просмотра**, а LeftNav/редактирование конфигурации блокируются (см. раздел 2).


```
┌──────────────────────────────────────────────────────────────────────────────┐
│ Header: WebLoadTester   [Настройки] [Папка прогонов]   DB: OK   TG: On/Off  │
├──────────────────────────────────────────────────────────────────────────────┤
│ Tabs: UI тестирование | HTTP тестирование | Сеть и безопасность | Прогоны     │
├───────────────┬───────────────────────────────────────────────┬──────────────┤
│ Modules list   │ Workspace (один вертикальный скролл)          │ Details pane │
│ + Search       │                                               │ (опционально)│
├───────────────┴───────────────────────────────────────────────┴──────────────┤
│ Log drawer (всегда доступен снизу; отдельный скролл)                           │
└──────────────────────────────────────────────────────────────────────────────┘
```

### 1.1. Размеры и ресайз (FullHD)
- **LeftNav**: 260–320px (min 220, max 420) + Splitter.
- **Details pane (справа, опционально)**: 320–380px (min 280, max 520) + Splitter.
- **Log drawer**: collapsed по умолчанию, expanded 260–320px (min 160).

### 1.2. Правило скролла (строго)
- Внутри Workspace: **один вертикальный ScrollViewer**.
- Внутри Log drawer: **отдельный ScrollViewer**.
- Внутри Workspace **не используем вложенные вертикальные скроллы**.

Отсюда важное правило списков:
- Все “табличные” данные (Steps/Endpoints/Assets/Headers) отображаем как **Row-block list** (см. раздел 6.7) — без отдельной вертикальной прокрутки внутри списка.

- Внутри Workspace: **один вертикальный ScrollViewer**.
- Внутри Log drawer: **отдельный ScrollViewer**.
- Внутри Workspace **не используем DataGrid со встроенным скроллом**. Списки (шаги/эндпоинты/хедеры) делаем как вертикальные “row blocks” (ItemsRepeater/ListBox), чтобы скролл был только у Workspace.

---

## 2. Состояния приложения и блокировки

### 2.1. Запрет смены модуля во время Running (ФИКС)
**Во время Running выбор модуля заблокирован.**
- Клик по другому модулю не меняет выбор.
- В Workspace/Status показываем короткое сообщение: “Идёт запуск. Остановите тест, чтобы сменить модуль.”

### 2.2. Блокировки при Running
- В Workspace **все поля конфигурации** (и конфиг, и RunProfile, и module settings) → disabled.
- Доступны: **Stop**, лог, просмотр артефактов текущего run (если уже созданы), “Открыть папку прогона”.

---

## 3. Workspace: структура секций (единая для всех модулей)
Workspace всегда идёт сверху вниз:

1) **Управление запуском (Run Control Row)**
2) **Конфигурация теста (TestCase)**
3) **Параметры запуска (RunProfile)**
4) **Настройки выбранного модуля (Module Settings)**
5) (опц.) **Подсказки/дисклеймеры**

Эта структура неизменна, чтобы пользователь “на автомате” понимал где что искать.

---

## 4. Run Control Row (внутри Workspace)
Кнопки и статусы:
- **Start**, **Stop**, (опц.) Restart
- Status: Idle / Running / Completed / Error / Stopped
- Progress: `x/y`, стадия (например “Launching browser”, “Step 3/10 …”)
- Быстрые действия: **Открыть папку прогона**, **Открыть report.html** (если включен)

Поведение:
- Enter в любом TextBox **не запускает** тест.
- Start запускает текущую конфигурацию (TestCase + RunProfile snapshot + ModuleSettings).

---

## 5. Секция «Конфигурация теста» (TestCase)
Цель: управлять сохранением/загрузкой параметров конкретного теста (версионирование).

Состав:
- ComboBox: **Выбранная конфигурация** (список тестов для текущего модуля)
- TextBox: **Имя** (обяз.)
- TextBox: **Описание** (опц., multiline)
- Подсказка: **“Будет сохранено как: {FinalNamePreview}”**
- Кнопки: **Загрузить**, **Сохранить**, **Сохранить как**, **Удалить**

Правила имени:
- FinalName = `UserName + "_" + ModuleSuffix`
- ModuleSuffix фиксирован:
  - A1: UIСценарий
  - A2: UISнимки
  - A3: UITайминги
  - B1: HTTPФункциональные
  - B2: HTTPПроизводительность
  - B3: HTTPАссеты
  - C1: СетьДиагностика
  - C2: СетьДоступность
  - C3: SecurityBaseline
  - C4: Preflight

Взаимодействия:
- **Загрузить**: заполняет RunProfile + Module Settings из выбранной конфигурации.
- **Сохранить**: сохраняет в текущую конфигурацию (как новая версия), если выбрана.
- **Сохранить как**: создаёт новую конфигурацию (новый TestCase) + первая версия.
- **Удалить**: удаляет конфигурацию (с подтверждением).

UX-валидация:
- Если “Имя” пустое → Save/SaveAs недоступны (или показывают ошибку “Имя обязательно”).
- Ошибки показываем **под кнопками** списком.

---

## 6. Секция «Параметры запуска» (RunProfile)
Цель: единые параметры выполнения, не зависящие от конкретного модуля.

### 6.1. Обязательные поля
- **Mode**: Iterations / Duration
- **Iterations** (если Mode=Iterations)
- **DurationSeconds** (если Mode=Duration)
- **Parallelism** (1..N)
- **TimeoutSeconds** (>=1)

### 6.2. Дополнительные поля
- **PauseBetweenIterationsMs** (>=0)

### 6.3. Флаги
- HtmlReportEnabled
- TelegramEnabled
- PreflightEnabled (если применяешь общий preflight перед запуском)

### 6.4. UI-specific (показываем только на вкладке UI тестирование)
- **Headless** (или более понятная инверсия: “Показывать браузер”)
- **ScreenshotsPolicy**: Off / OnError / Always

### 6.5. Safe defaults (если пользователь не заполнил)
- Parallelism = 1
- Mode = Iterations
- Iterations = 10
- DurationSeconds = 30
- TimeoutSeconds = 30
- PauseBetweenIterationsMs = 0

### 6.6. Warnings (не блокируют запуск)
- Iterations > 200
- DurationSeconds > 300
- Parallelism > 10

### 6.7. Details pane (правая панель) — состав и поведение
Правая панель нужна не для “красоты”, а чтобы **не раздувать основную форму** и не мешать заполнению параметров.

**Состав (сверху вниз):**
1) **Run summary**
   - Текущий TestName / Module
   - Status
   - Progress: x/y + время
   - Последняя ошибка (1–2 строки) + кнопка “Показать в логе”
2) **Artifacts**
   - Путь к папке прогона (только чтение)
   - Кнопки: “Открыть папку”, “Открыть HTML”, “Открыть report.json”
3) **Telegram (глобально, компактно)**
   - Enabled
   - (опц.) быстрые переключатели уведомлений: OnFinish / OnError
   - Ссылка/кнопка “Открыть полные настройки” (если есть отдельное окно/диалог)
4) **Help / Shortcuts**
   - F5 Start, Shift+F5 Stop, Ctrl+L лог

**Поведение:**
- В Idle: всё доступно.
- В Running:
  - Summary и Artifacts — активны (только чтение + открытие).
  - Telegram — **disabled** (чтобы не менять политику на лету).
- На узких окнах (<1200px): правая панель сворачивается (кнопка-выдвижение).

**Заметка:** Details pane — *опциональна*, но мы делаем её по умолчанию, потому что она снижает хаос в центральной форме.

Цель: единые параметры выполнения, не зависящие от конкретного модуля.

### 6.1. Обязательные поля
- **Mode**: Iterations / Duration
- **Iterations** (если Mode=Iterations)
- **DurationSeconds** (если Mode=Duration)
- **Parallelism** (1..N)
- **TimeoutSeconds** (>=1)

### 6.2. Дополнительные поля
- **PauseBetweenIterationsMs** (>=0)

### 6.3. Флаги
- HtmlReportEnabled
- TelegramEnabled
- PreflightEnabled (если применяешь общий preflight перед запуском)

### 6.4. UI-specific (показываем только на вкладке UI тестирование)
- **Headless** (или более понятная инверсия: “Показывать браузер”)
- **ScreenshotsPolicy**: Off / OnError / Always

### 6.5. Safe defaults (если пользователь не заполнил)
- Parallelism = 1
- Mode = Iterations
- Iterations = 10
- DurationSeconds = 30
- TimeoutSeconds = 30
- PauseBetweenIterationsMs = 0

### 6.6. Warnings (не блокируют запуск)
- Iterations > 200
- DurationSeconds > 300
- Parallelism > 10

### 6.7. UX-подсказки
- Если Headless = ON → плашка: “Headless включён — окно браузера не откроется”.

---

## 7. Общие правила UX-валидации (всем модулям)
1) **Start всегда доступен** в Idle, но при старте:
   - выполняется Validate
   - если ошибки → запуск не начинается, ошибки показываются **сверху секции Module Settings** и (опц.) в Status.
2) Ошибки формулируем как “что исправить”, без технич. стека.
3) Обязательные поля отмечаем “(обяз.)” в label.

---

## 8. Hotkeys и навигация
- **F5**: Start
- **Shift+F5**: Stop
- **Ctrl+L**: открыть/сфокусировать Log drawer
- **Ctrl+F**: фокус в поле фильтра лога
- **Ctrl+C**: копировать выделенные строки лога (если фокус в логах)
- **Ctrl+S**: Сохранить (если валидно и выбрана конфигурация)

Фокус:
- Tab/Shift+Tab — линейный обход полей.
- Esc — закрыть выпадающие списки/снять редактирование строки (в списках).

---

## 9. Настройки модулей (10/10): минимум, дефолты, валидация
Важно: ниже — **только module-specific**. Всё “iterations/duration/parallelism/timeout/headless/screenshot policy” — в RunProfile.

### 9.0. Единый шаблон списков (Row-block list) — для Steps/Endpoints/Assets/Headers
**Зачем:** избежать DataGrid-вложенного скролла и сделать одинаковые действия во всех модулях.

**Структура:**
- Заголовок секции + короткая подсказка.
- Панель действий (Toolbar):
  - **Добавить**
  - **Удалить** (disabled, если ничего не выбрано)
  - **Вверх / Вниз** (disabled на границах)
  - **Дублировать** (optional)
- Список строк (ItemsRepeater/ListBox), каждая строка — “row-block”.

**Row-block (строка) — правила:**
- Каждая строка кликабельна для выбора.
- Поля внутри строки редактируются напрямую (TextBox/ComboBox/NumericUpDown).
- Кнопка удаления может быть в конце строки (маленькая), но основное удаление — через Toolbar.

**Клавиатура и мышь:**
- Колесо мыши прокручивает **весь Workspace**, а не только список.
- ↑/↓ по строкам (когда фокус в списке).
- Ctrl+N — добавить строку (optional).
- Delete — удалить выбранную строку (optional, с подтверждением для “опасных” списков).

**Валидация в списках:**
- Ошибка по конкретной строке показывается под строкой (1–2 строки текста).
- При Start ошибки агрегируются сверху секции.

---

### A1. ui.scenario — UI Scenario
Минимум для запуска:
- StartUrl (обяз.)
- Steps (>=1)
- Корректность каждого шага по правилам Action ниже

Секции Module Settings:
1) StartUrl (TextBox)
2) Steps (Row-block list)
   - Row fields (фиксировано Variant B):
     - **Действие (Action)** — ComboBox (русские названия)
     - **Селектор (Selector)** — TextBox
     - **Значение (Value)** — TextBox
     - **Задержка (DelayMs)** — NumericUpDown
   - Toolbar: **Добавить / Удалить / Вверх / Вниз / Дублировать**
3) StepErrorPolicy (ComboBox: SkipStep / StopRun / StopAll)
4) WaitAfterNavigationMs (Numeric, дефолт 0)

Дефолты:
- StepErrorPolicy = StopRun
- WaitAfterNavigationMs = 0
- Steps = 1 строка:
  - Action = **Клик**
  - Selector = пусто
  - Value = пусто
  - DelayMs = 0

#### A1.1. Набор действий UiScenario (MVP) — русские названия
Комбо-бокс “Действие” содержит (строго этот набор на MVP):
1) **Перейти** (Navigate)
2) **Ждать элемент** (Wait)
3) **Клик** (Click)
4) **Ввести** (Fill)
5) **Проверить текст** (AssertText)
6) **Скриншот** (Screenshot)
7) **Пауза** (Delay)

#### A1.2. Семантика столбцов (важно)
- **DelayMs** = задержка перед шагом (для всех действий), **кроме «Пауза»**, где DelayMs = длительность паузы. 
- Важно (реализация): для Action=Delay не выполнять «задержку перед шагом», иначе будет двойная пауза.
- **Action** определяет, как интерпретировать Selector/Value.

#### A1.3. Правила обязательности полей по Action
1) **Перейти (Navigate)**
   - Value: **обяз.** абсолютный URL или путь (если путь, он будет склеен с StartUrl как BaseUrl — если так реализуем; иначе требуем абсолютный URL).
   - Selector: не используется (должен быть пустым).
   - DelayMs: опц.

2) **Ждать элемент (Wait)**
   - Selector: **обяз.**
   - Value: не используется (держим пустым; резерв под будущие расширения)
   - DelayMs: опц. (задержка перед шагом)

3) **Клик (Click)**
   - Selector: **обяз.**
   - Value: не используется (пусто)
   - DelayMs: опц.

4) **Ввести (Fill)**
   - Selector: **обяз.**
   - Value: **обяз.** (текст, который вводим)
   - DelayMs: опц.

5) **Проверить текст (AssertText)**
   - Selector: **обяз.** (элемент, внутри которого ищем текст)
   - Value: **обяз.** (ожидаемый текст)
   - DelayMs: опц.
   - Правило проверки (MVP): **text contains Value**. (Ровное сравнение/regex — позже.)

6) **Скриншот (Screenshot)**
   - Selector: опц. (если задан — скриншот элемента, иначе всей страницы)
   - Value: опц. (метка/имя шага для имени файла)
   - DelayMs: опц.
   - Отличие от политики RunProfile: этот шаг **всегда** делает скриншот, независимо от ScreenshotsPolicy.

7) **Пауза (Delay)**
   - Selector: не используется (пусто)
   - Value: не используется (пусто)
   - DelayMs: **обяз.** (>0) — длительность паузы в мс
   - Важно: для этого Action задержка «перед шагом» **не применяется**, иначе будет двойная пауза.

#### A1.4. UX-валидация (как показываем ошибки)
- При редактировании строки: ошибки показываются **под строкой** (1–2 строки):
  - “Перейти: Value (URL) обязателен”
  - “Клик: Selector обязателен”
  - “Пауза: DelayMs должен быть больше 0”
- При Start: агрегированный список ошибок сверху секции Steps:
  - “Шаг 3: Клик — не задан Selector”
  - “Шаг 5: Пауза — DelayMs должен быть больше 0”

Плейсхолдеры (без цветов, но информативные):
- Selector: “CSS селектор, например: #login-button”
- Value:
  - Navigate: “https://example.com/page”
  - Fill: “текст для ввода”
  - AssertText: “ожидаемый текст”
  - Wait: “(Value не используется — оставьте пустым)”
  - Delay: “(Value не используется — оставьте пустым)”

#### A1.5. Взаимодействия в редакторе шагов
- **Добавить**: добавляет строку ниже выбранной (если есть выбор), иначе в конец.
- **Удалить**: удаляет выбранную строку (если 1 строка — не даём удалить, только очищаем поля).
- **Вверх/Вниз**: перемещает выбранную строку.
- **Дублировать**: копирует строку и вставляет ниже.

Hotkeys (внутри списка шагов):
- Ctrl+D — дублировать
- Alt+Up / Alt+Down — переместить строку вверх/вниз
- Delete — удалить строку (если можно)
- Ctrl+N — добавить строку

---

### A2. ui.snapshot — UI Snapshot
Минимум:
- TargetUrl (обяз.)

Секции:
1) TargetUrl (TextBox)
2) Selector (опц. TextBox) — если пусто, делаем full page
3) WaitAfterLoadMs (Numeric, дефолт 0)

Дефолты:
- Selector пуст
- WaitAfterLoadMs = 0

Валидация:
- TargetUrl абсолютный URL

---

### A3. ui.timing — UI Timing
Минимум:
- TargetUrl (обяз.)

Секции:
1) TargetUrl
2) WaitUntil (ComboBox: domcontentloaded / load / networkidle (если есть))
3) WarmupRuns (Numeric, дефолт 1)

Дефолты:
- WaitUntil = domcontentloaded
- WarmupRuns = 1

Валидация:
- TargetUrl абсолютный URL

Примечание:
- Количество измерений берём из RunProfile (Iterations/Duration).

---

### B1. http.functional — HTTP Functional
Минимум:
- хотя бы 1 Endpoint с абсолютным URL

Секции:
1) Endpoints (Row-block list)
   - Row: Method (ComboBox), Url (TextBox), ExpectedStatus (Numeric)
2) Headers (опц. Row-block list)
   - Row: Key, Value
3) Body (опц. multiline)
4) Assertions (MVP): ContainsText (опц.)

Дефолты:
- 1 endpoint строка: Method=GET, ExpectedStatus=200

Валидация:
- Endpoints.Count >= 1
- Url каждого endpoint абсолютный
- ExpectedStatus: 100..599

---

### B2. http.performance — HTTP Performance
Минимум:
- TargetUrl (обяз.)

Секции:
1) TargetUrl + Method
2) Headers (опц. Row-block list)
3) Safety note (текст): “использовать только на своих ресурсах/с разрешения”

Дефолты:
- Method=GET

Валидация:
- TargetUrl абсолютный URL

---

### B3. http.assets — HTTP Assets
Минимум:
- хотя бы 1 Asset Url (обяз.)

Секции:
1) Assets (Row-block list)
   - Row: Url (обяз), ExpectedContentType (опц), MaxSizeKb (опц), MaxLatencyMs (опц)

Дефолты:
- 1 пустая строка

Валидация:
- Assets.Count >= 1
- Url абсолютный

---

### C1. net.dnsTcpTls — Network Diagnostics (DNS/TCP/TLS)
Минимум:
- Hostname/IP (обяз.)

Секции:
1) Hostname/IP
2) Toggles: EnableDns / EnableTcp / EnableTls
3) Ports (Row-block list чисел)

Дефолты:
- EnableDns=ON, EnableTcp=ON, EnableTls=ON
- Ports: 80, 443

Валидация:
- Hostname не пуст
- Если EnableTcp или EnableTls = ON → ports.Count >= 1

---

### C2. net.availability — Availability Monitor
Минимум:
- Target (обяз.)

Секции:
1) TargetType (ComboBox: HTTP / TCP)
2) Target (Url/Host)
3) Port (Numeric, enabled только при TCP)
4) IntervalSeconds (Numeric, >=0)

Дефолты:
- TargetType = HTTP
- IntervalSeconds = 0

Валидация:
- Target не пуст
- Если TCP → Port обязателен (1..65535)

---

### C3. net.securityBaseline — Security Baseline (без атак)
Минимум:
- Url (обяз.)

Секции:
1) Url
2) Checklist (фиксированный список, чекбоксы)
   - HTTPS
   - HSTS
   - X-Content-Type-Options
   - X-Frame-Options
   - CSP
   - Referrer-Policy
   - Permissions-Policy

Дефолты:
- Все чекбоксы ON

Валидация:
- Url абсолютный

---

### C4. net.preflight — Preflight Readiness
Минимум:
- TargetHost (обяз., если CheckNetwork=ON)

Секции:
1) CheckNetwork (Checkbox)
2) TargetHost (TextBox)
3) TargetPort (Numeric)
4) CheckPlaywright (Checkbox)
5) CheckSQLite (Checkbox)

Дефолты:
- CheckNetwork=ON
- CheckPlaywright=ON
- CheckSQLite=ON
- TargetPort=443

Валидация:
- Если CheckNetwork=ON → TargetHost обязателен

---
Важно: ниже — **только module-specific**. Всё “iterations/duration/parallelism/timeout/headless/screenshot policy” — в RunProfile.

### A1. ui.scenario — UI Scenario
Минимум для запуска:
- StartUrl (обяз.)
- Steps (>=1)
- Каждый Step: Selector (обяз.), Value/Text (опц.)

Секции Module Settings:
1) StartUrl (TextBox)
2) Steps (вертикальный список row-block)
   - Row: Action (ComboBox, русские названия), Selector, Value, DelayMs
   - Toolbar: Add / Remove / Up / Down / Duplicate
3) StepErrorPolicy (ComboBox: SkipStep / StopRun / StopAll)
4) WaitAfterNavigationMs (Numeric, дефолт 0–500)

Дефолты:
- StepErrorPolicy = StopRun
- WaitAfterNavigationMs = 0
- Steps = 1 пустая строка (Selector пустой, чтобы пользователь явно заполнил)

Валидация:
- StartUrl: абсолютный URL
- Steps.Count >= 1
- Для каждого шага: Selector не пуст

Поведение шагов (канон MVP):
- Если Value пустой → Click
- Если Value заполнен → Fill/Type
- Action поле используется только для совместимости/будущего расширения.

---

### A2. ui.snapshot — UI Snapshot
Минимум:
- TargetUrl (обяз.)

Секции:
1) TargetUrl (TextBox)
2) Selector (опц. TextBox) — если пусто, делаем full page
3) WaitAfterLoadMs (Numeric, дефолт 0–500)

Дефолты:
- Selector пуст
- WaitAfterLoadMs = 0

Валидация:
- TargetUrl абсолютный URL

---

### A3. ui.timing — UI Timing
Минимум:
- TargetUrl (обяз.)

Секции:
1) TargetUrl
2) WaitUntil (ComboBox: domcontentloaded / load / networkidle (если есть))
3) WarmupRuns (Numeric, дефолт 1)

Дефолты:
- WaitUntil = domcontentloaded
- WarmupRuns = 1

Валидация:
- TargetUrl абсолютный URL

Примечание:
- Количество измерений берём из RunProfile (Iterations/Duration).

---

### B1. http.functional — HTTP Functional
Минимум:
- хотя бы 1 Endpoint с абсолютным URL

Секции:
1) Endpoints (вертикальный список)
   - Row: Method (ComboBox), Url (TextBox), ExpectedStatus (Numeric, опц.)
   - Toolbar: Add / Remove / Duplicate
2) Headers (опц. список Key/Value)
3) Body (опц. multiline)
4) Assertions (MVP): ContainsText (опц.)

Дефолты:
- В списке 1 endpoint строка:
  - Method=GET
  - ExpectedStatus=200

Валидация:
- Endpoints.Count >= 1
- Url каждого endpoint абсолютный
- ExpectedStatus: 100..599 (если задан)

---

### B2. http.performance — HTTP Performance
Минимум:
- TargetUrl (обяз.)

Секции:
1) TargetUrl + Method
2) Headers (опц.)
3) Safety note (текст): “использовать только на своих ресурсах/с разрешения”

Дефолты:
- Method=GET

Валидация:
- TargetUrl абсолютный URL

Примечание:
- Нагрузка определяется RunProfile (Iterations/Duration/Parallelism). Лимиты безопасности (например Parallelism max) — внутренняя защита + warning.

---

### B3. http.assets — HTTP Assets
Минимум:
- хотя бы 1 Asset Url (обяз.)

Секции:
1) Assets (список)
   - Row: Url (обяз), ExpectedContentType (опц), MaxSizeKb (опц), MaxLatencyMs (опц)
   - Toolbar: Add / Remove

Дефолты:
- 1 пустая строка

Валидация:
- Assets.Count >= 1
- Url абсолютный

---

### C1. net.dnsTcpTls — Network Diagnostics (DNS/TCP/TLS)
Минимум:
- Hostname/IP (обяз.)

Секции:
1) Hostname/IP
2) Toggles: EnableDns / EnableTcp / EnableTls
3) Ports (список чисел)

Дефолты:
- EnableDns=ON, EnableTcp=ON, EnableTls=ON
- Ports: 80, 443

Валидация:
- Hostname не пуст
- Если EnableTcp или EnableTls = ON → ports.Count >= 1

---

### C2. net.availability — Availability Monitor
Минимум:
- Target (обяз.)

Секции:
1) TargetType (ComboBox: HTTP / TCP)
2) Target (Url/Host)
3) Port (Numeric, enabled только при TCP)
4) IntervalSeconds (опц., >=0)

Дефолты:
- TargetType = HTTP
- IntervalSeconds = 0 (без дополнительной паузы внутри Execute; паузы/циклы — по RunProfile)

Валидация:
- Target не пуст
- Если TCP → Port обязателен (1..65535)

---

### C3. net.securityBaseline — Security Baseline (без атак)
Минимум:
- Url (обяз.)

Секции:
1) Url
2) Checklist (фиксированный список, чекбоксы)
   - HTTPS
   - HSTS
   - X-Content-Type-Options
   - X-Frame-Options
   - CSP
   - Referrer-Policy
   - Permissions-Policy

Дефолты:
- Все чекбоксы ON

Валидация:
- Url абсолютный

---

### C4. net.preflight — Preflight Readiness
Минимум:
- (опционально) TargetHost/Port, если включены сетевые проверки

Секции:
1) CheckNetwork (Checkbox)
2) TargetHost (TextBox)
3) TargetPort (Numeric)
4) CheckPlaywright (Checkbox)
5) CheckSQLite (Checkbox)

Дефолты:
- CheckNetwork=ON
- CheckPlaywright=ON
- CheckSQLite=ON
- TargetPort=443

Валидация:
- Если CheckNetwork=ON → TargetHost обязателен

---

## 10. Log drawer (внизу)
Collapsed:
- заголовок “Лог выполнения” + кнопка разворота

Expanded:
- Автоскролл (default ON)
- Только ошибки (default OFF)
- Clear / Copy
- Фильтр (Ctrl+F)
- Список строк лога (ограничение 5–10k строк)

Поведение автоскролла:
- Пока пользователь внизу — новые строки удерживают низ.
- Если пользователь пролистал вверх — новые строки не “дёргают” позицию.

---

## 11. Вкладка «Прогоны» (History)
Цель: история всех запусков, быстрый доступ к артефактам и повторный запуск.

Состав:
- Таблица прогонов (DateTime, TestName, ModuleName, Status, Duration, FailedItems, KeyMetrics, RunId)
- Фильтры: модуль, статус, период, поиск
- Действия: Открыть JSON/HTML, Открыть папку, Копировать RunId, Повторить запуск

---

## 12. Привязка к текущему коду (архив WebLoadTester 18.02.2026 9am.tar)
Цель этого раздела: чтобы UX-спека была **выполнима** без гадания — показываю, где именно в коде лежат модели/VM/Views, и какие минимальные изменения потребуются при внедрении нового UI.

### 12.1. Ключевые точки в кодовой базе
- Главное окно и табы групп:
  - `Presentation/Views/MainWindow.axaml`
  - `Presentation/Views/Tabs/UiTestingTab.axaml`
  - `Presentation/Views/Tabs/HttpTestingTab.axaml`
  - `Presentation/Views/Tabs/NetSecTab.axaml`
  - `Presentation/Views/Tabs/RunsTab.axaml`
- Рабочая область семейства (где будет left-nav / workspace / details):
  - `Presentation/Views/ModuleWorkspaceView.axaml`
  - `Presentation/ViewModels/Tabs/ModuleFamilyViewModel.cs`
- RunProfile (единые параметры запуска):
  - `Core/Domain/RunEntities.cs` (RunProfile)
  - `Presentation/ViewModels/RunProfileViewModel.cs`
- Конфигурации модулей (Config/Load/Save/Delete):
  - `Core/Domain/ModuleConfigPayload.cs`
  - `Presentation/ViewModels/ModuleConfigViewModel.cs`
- ViewModels настроек модулей (10 шт.):
  - `Presentation/ViewModels/SettingsViewModels/*SettingsViewModel.cs`
- Views настроек модулей (10 шт.):
  - `Presentation/Views/SettingsViews/*SettingsView.axaml`

### 12.2. Где сейчас «красота» и что будет отключено в minimal-UI режиме
Мы не опираемся на текущий внешний вид, но важно понимать источники:
- `Presentation/Styles/DesignTokens.axaml`
- `Presentation/Styles/Workspace.axaml`
- `Presentation/Styles/Controls.axaml`

Для режима «без красоты»:
- оставляем **только отступы/интервалы** (PagePadding, FieldSpacing, CardSpacing) и базовую типографику,
- временно убираем/не используем классы вроде `section`, `app-bar`, `warning-panel`, `segmented-bar` и т.п.

### 12.3. Реализация выбранной навигации (Tabs сверху + LeftNav слева)
Сейчас выбор модулей у тебя реализован внутри `ModuleWorkspaceView` через горизонтальный ListBox.

TO‑BE:
- Вкладки сверху (группы) уже есть: Ui/Http/NetSec/Runs.
- Внутри `ModuleWorkspaceView` делаем Grid:
  - Column 0 (LeftNav): список модулей текущей группы
  - Column 1 (Workspace): центральная форма (ScrollViewer один)
  - Column 2 (Details pane): правая панель (сворачиваемая)

Точка изменений: `Presentation/Views/ModuleWorkspaceView.axaml`.

### 12.4. Row-block list вместо DataGrid (единый шаблон)
Сейчас часть модулей использует `Avalonia.Controls.DataGrid` (например, UiScenario).

TO‑BE:
- заменить DataGrid на ItemsControl/ListBox с шаблоном строки (“row-block”),
- toolbar действий оставить как отдельный блок над списком,
- никаких вложенных вертикальных скроллов (скроллит только Workspace).

Первые кандидаты на замену:
- `Presentation/Views/SettingsViews/UiScenarioSettingsView.axaml` (DataGrid Steps)
- `UiSnapshotSettingsView.axaml` (targets)
- `UiTimingSettingsView.axaml` (targets)
- `HttpFunctionalSettingsView.axaml` (endpoints)
- `HttpPerformanceSettingsView.axaml` (endpoints)
- `HttpAssetsSettingsView.axaml` (assets)
- `NetDiagnosticsSettingsView.axaml` (ports)

### 12.5. Мэппинг полей UX‑спеки на текущие модели Settings (10/10)
Это важно, чтобы новый UI сразу писал/читал то, что реально есть в доменной модели.

**A1. ui.scenario**
- StartUrl (в UI) ↔ `UiScenarioSettings.TargetUrl`
- Steps ↔ `UiScenarioSettings.Steps : List<UiStep>`
  - Action ↔ `UiStep.Action` (enum: Navigate/WaitForSelector/Click/Fill/AssertText/Screenshot/Delay)
  - Selector ↔ `UiStep.Selector`
  - Value ↔ `UiStep.Value`
  - DelayMs ↔ `UiStep.DelayMs`
- Важно:
  - `UiScenarioSettings.ErrorPolicy` — legacy (модуль не использует)
  - `UiScenarioSettings.TimeoutMs` используется модулем; в UI можно перенести в «Дополнительно».

**A2. ui.snapshot**
- Targets list ↔ `UiSnapshotSettings.Targets : List<SnapshotTarget>`
  - Url / Name / Selector
- WaitUntil ↔ `UiSnapshotSettings.WaitUntil` (UiWaitUntil)
- TimeoutSeconds ↔ `UiSnapshotSettings.TimeoutSeconds`
- FullPage ↔ `UiSnapshotSettings.FullPage`
- ViewportWidth/Height ↔ соответствующие nullable

**A3. ui.timing**
- Targets list ↔ `UiTimingSettings.Targets : List<TimingTarget>`
- WaitUntil ↔ `UiTimingSettings.WaitUntil`
- TimeoutSeconds ↔ `UiTimingSettings.TimeoutSeconds`

**B1. http.functional**
- BaseUrl ↔ `HttpFunctionalSettings.BaseUrl`
- Endpoints ↔ `HttpFunctionalSettings.Endpoints : List<HttpFunctionalEndpoint>`
  - Name, Method, Path, ExpectedStatusCode
  - RequiredHeaders ↔ удобнее редактировать через `RequiredHeadersText` (строка с `;`)
  - JsonFieldEquals ↔ через `JsonFieldEqualsText` (строка с `;`)
  - BodyContains ↔ отдельное поле

**B2. http.performance**
- BaseUrl ↔ `HttpPerformanceSettings.BaseUrl`
- Endpoints ↔ `HttpPerformanceSettings.Endpoints : List<HttpPerformanceEndpoint>`

**B3. http.assets**
- Assets ↔ `HttpAssetsSettings.Assets : List<AssetItem>`
  - Url, Name, ExpectedContentType, MaxSizeKb, MaxLatencyMs

**C1. net.diagnostics**
- Hostname ↔ `NetDiagnosticsSettings.Hostname`
- Toggle DNS/TCP/TLS ↔ `CheckDns/CheckTcp/CheckTls`
- AutoPorts ↔ `UseAutoPorts`
- Ports ↔ `Ports : List<DiagnosticPort>`

**C2. availability**
- Тип проверки ↔ `AvailabilitySettings.CheckType` (HTTP/TCP)
- Url/Host/Port ↔ соответствующие поля
- Target (только чтение) ↔ `AvailabilitySettings.Target`

**C3. security.baseline**
- Url ↔ `SecurityBaselineSettings.Url`
- Чекбоксы ↔ `Check*` поля (включая RedirectHttpToHttps и CookieFlags)

**C4. preflight**
- Target ↔ `PreflightSettings.Target`
- Toggles ↔ `CheckDns/CheckTcp/CheckTls/CheckHttp`

### 12.6. Минимальные правки для согласования UiScenario с UX‑спекой
Чтобы UiScenario соответствовал описанной семантике (и не делал двойную паузу):
- В `Modules/UiScenario/UiScenarioModule.cs`:
  - при Action=Delay **не выполнять** общий pre-delay `if (step.DelayMs > 0) Task.Delay(...)` перед switch,
  - а в case Delay выполнять только «основную паузу» `Task.Delay(step.DelayMs)`.
- Валидация уже почти подходит (DelayMs>0), но текст ошибок обновить под новую формулировку.

## 13. Wireframe нового ModuleWorkspaceView (v1.6)
Цель: зафиксировать геометрию и взаимодействия так, чтобы реализация была однозначной.

### 13.1. Базовая раскладка (1920×1080, окно 1600–1800px шириной)

```
┌──────────────────────────────────────────────────────────────────────────────────────────────┐
│ WebLoadTester                 [Настройки] [Открыть папку прогонов]    DB: OK   TG: On/Off     │
├──────────────────────────────────────────────────────────────────────────────────────────────┤
│ Tabs:  UI тестирование | HTTP тестирование | Сеть и безопасность | Прогоны                     │
├───────────────┬───────────────────────────────────────────────┬──────────────────────────────┤
│ LeftNav        │ Workspace (один вертикальный скролл)          │ Details pane                 │
│ ┌───────────┐  │ ┌─────────────────────────────────────────┐  │ ┌──────────────────────────┐│
│ │ Search... │  │ │ Run Control: [Start][Stop] Status/Prog  │  │ │ Run summary               ││
│ └───────────┘  │ ├─────────────────────────────────────────┤  │ │ - Test/Module             ││
│ ┌───────────┐  │ │ TestCase: (Combo) Name/Desc Save/Load   │  │ │ - Status/Progress/Timer   ││
│ │ Modules   │  │ ├─────────────────────────────────────────┤  │ │ - Last error → Show in log││
│ │ (list)    │  │ │ RunProfile: Mode/Iter/Duration/Parallel │  │ └──────────────────────────┘│
│ │           │  │ ├─────────────────────────────────────────┤  │ ┌──────────────────────────┐│
│ │           │  │ │ Module Settings: (sections + row-blocks) │  │ │ Artifacts                 ││
│ └───────────┘  │ └─────────────────────────────────────────┘  │ │ - Open folder / HTML / json││
├───────────────┴───────────────────────────────────────────────┴──────────────────────────────┤
│ Log drawer  [▼/▲]  Autoscroll[ ]  OnlyErrors[ ]  Filter[...]  [Copy] [Clear]                   │
│ ──────────────────────────────────────────────────────────────────────────────────────────── │
│ (log lines, scroll)                                                                            │
└──────────────────────────────────────────────────────────────────────────────────────────────┘
```

Размеры (целевые):
- LeftNav: 260–320px (min 220)
- Details: 320–380px (min 280)
- Workspace: остальное, min 600px
- Log drawer: collapsed=1 строка, expanded=260–320px (min 160)

### 13.2. Узкое окно (например 1200px)
- Details pane сворачивается в кнопку “Details” (в заголовке Workspace или справа от Tabs).
- При раскрытии Details — выезжает поверх Workspace (overlay) или занимает правую колонку (если место есть).

```
┌──────────────────────────────────────────────────────────────────────────┐
│ WebLoadTester  [Настройки]   DB:OK TG:On  [Details ▸]                     │
├──────────────────────────────────────────────────────────────────────────┤
│ Tabs: UI | HTTP | NetSec | Runs                                           │
├───────────────┬──────────────────────────────────────────────────────────┤
│ LeftNav        │ Workspace (scroll)                                       │
├───────────────┴──────────────────────────────────────────────────────────┤
│ Log drawer …                                                             │
└──────────────────────────────────────────────────────────────────────────┘
```

### 13.3. Малая высота (например 900px и ниже)
- Log drawer по умолчанию collapsed.
- При раскрытии — не больше 35–40% высоты.

---

## 14. Сценарии взаимодействий (мышь/клавиатура) — строго

### 14.1. Выбор группы и модуля
- Клик по Tab → меняет список модулей слева.
- Внутри каждой вкладки запоминается SelectedModule.
- Если впервые зашли во вкладку — автоматически выбирается первый модуль.
- Во время Running: Tabs доступны для просмотра, LeftNav и редактирование конфигурации — **disabled**.

### 14.2. Скролл
- Колесо мыши над Workspace → скроллит Workspace.
- Колесо над Log → скроллит Log.
- Внутри row-block list колёсико **не должно перехватываться** отдельным списком (скроллит Workspace).

### 14.3. Splitters
- Splitter между LeftNav/Workspace и Workspace/Details:
  - drag меняет ширины
  - double-click сбрасывает к дефолту (optional, но удобно)

### 14.4. Конфигурации TestCase (без лишних диалогов)
**Цель:** не терять изменения, но и не раздражать подтверждениями.

Правило “Draft”:
- Любое изменение в полях RunProfile/ModuleSettings помечает состояние как **Dirty**.
- Dirty отображаем минимально: `*` рядом с именем конфигурации или текст “Не сохранено”.
- При переключении модуля/вкладки в Idle:
  - **не спрашиваем** подтверждение,
  - сохраняем изменения в **draft (в памяти)** для данной пары (ModuleId + ConfigId).
- Кнопка “Сохранить” сохраняет draft в постоянное хранилище.
- При закрытии приложения, если есть dirty-drafts: один диалог “Есть несохранённые изменения (N). Сохранить / Не сохранять / Отмена”.

Кнопки:
- Load → загружает сохранённое состояние (сбрасывает draft)
- Save → сохраняет в текущую конфигурацию
- SaveAs → новая конфигурация
- Delete → подтверждение (да/нет)

### 14.5. Запуск
- F5 или Start:
  1) Validate RunProfile
  2) Validate ModuleSettings
  3) Если ошибки → не запускаем; показываем ошибки:
     - сверху секции ModuleSettings
     - плюс коротко в статус-строке Run Control
  4) Если ok → Running

- Shift+F5 или Stop:
  - немедленно останавливает
  - статус: Stopped

Во время Running:
- все поля disabled
- доступно: Stop, Log, Open folder/html/json

### 14.6. Log drawer
- В collapsed состоянии видна 1 строка управления.
- Ctrl+L:
  - если collapsed → expand и фокус в лог
  - если expanded → collapsed
- Autoscroll:
  - по умолчанию ON
  - если пользователь прокрутил вверх — автоскролл не “перетягивает” вниз

### 14.7. Details pane
- Содержит: Run summary + Artifacts + Telegram compact + Help.
- “Show in log” переводит фокус на Log и применяет фильтр по correlated id/ошибке (если реализовано) либо просто скроллит к последней ошибке.
- Telegram в Running disabled.

---

## 15. Реализация списков: Row-block list (единый контрол)
Чтобы не размазывать логику по 10 views, делаем единый UserControl:
- `RowListEditor<TItem>` с:
  - Toolbar (Add/Remove/Up/Down/Duplicate)
  - ItemsPresenter
  - SelectedIndex
  - Commands

Каждый модуль просто определяет Template строки.

---

## 16. Если можно «переделать максимально всё» — рекомендуемая реструктуризация кода под новый UI
(Это не дизайн-решения, а подсказка, как проще реализовать новый UX без оглядки на старую разметку.)

### 16.1. Новый “shell” уровень
- `MainWindow` содержит только: Header + Tabs + общий Log drawer.
- Внутри Tab’ов — один общий `ModuleWorkspaceView` с параметрами (FamilyId).

### 16.2. Унификация модулей
Ввести интерфейс (в домене или Presentation):
- `IModuleDescriptor` (ModuleId, DisplayName, FamilyId)
- `IModuleSettingsViewModel` (Validate(), GetPayload(), LoadPayload())
- `IModuleRunner` (RunAsync(payload, runProfile, ct))

### 16.3. RunProfile как единый источник правды
- RunProfile хранится отдельно, подмешивается к запуску каждого модуля.
- ModuleSettings не дублирует общие поля.

### 16.4. Удаление DataGrid из critical-path
- Все списки → Row-block list.

### 16.5. Отвязка “красоты”
- В стилях оставить только spacing/typography.
- Любые визуальные украшения вернуть позже отдельным этапом.

---

## 17. Row-block list — единые правила (обязательные)
Это — общий контракт для всех списков. Он должен быть одинаковым во всех модулях.

### 17.1. Toolbar (над списком)
Кнопки (в порядке слева направо):
- **Добавить**
- **Удалить** (disabled, если нет выбранной строки)
- **Вверх** / **Вниз** (disabled, если строка на границе)
- **Дублировать** (опционально; disabled, если нет выбранной строки)

Поведение:
- Добавить: вставляет строку **ниже выбранной**, иначе в конец.
- Удалить:
  - если строк > 1 → удаляет
  - если строка одна → не удаляем, а **очищаем значения**

### 17.2. Выбор строки
- Клик по любому месту строки → выделение строки.
- При выборе строки активируются кнопки toolbar.
- Переключение выбора не должно “прыгать” скроллом.

### 17.3. Inline ошибки
- Ошибка конкретной строки показывается **под строкой** (1–2 строки текста).
- Агрегированный список ошибок при Start — сверху секции.

### 17.4. Hotkeys (внутри списка)
- **Ctrl+N**: Добавить строку
- **Delete**: Удалить выбранную строку (если возможно)
- **Ctrl+D**: Дублировать
- **Alt+Up / Alt+Down**: Переместить строку вверх/вниз
- **Esc**: отменить редактирование текущего поля (если нужно)

### 17.5. Геометрия строки (без стилей)
- Высота строки: одна линия контролов + (опц.) строка ошибки снизу.
- Межстрочный отступ: 6–8px.
- Внутри строки: поля в Grid-колонках.
- Все строки по ширине равны, без горизонтального скролла.

---

## 18. Точные row-template для списков (10 модулей)
Ниже — **точные поля строки** и рекомендуемые ширины колонок.
Ширины даю как “фикс + звездочки” (Grid): `140 | 2* | 2* | 90`.

### 18.1. A1 ui.scenario — Steps
**Секция:** Steps (Row-block list)

**Строка шага (Grid):**
- `140 | 2* | 2* | 96`
  1) **Действие (ComboBox)** ширина ~140
  2) **Selector (TextBox)** 2*
  3) **Value (TextBox)** 2*
  4) **DelayMs (NumericUpDown)** ~96 (правый край)

**Плейсхолдеры (динамические по Action):**
- Selector:
  - Navigate / Delay: “(не используется)” (и поле disabled)
  - Wait/Click/Fill/AssertText: “CSS/XPath селектор, напр. #login”
  - Screenshot: “селектор (опционально)”
- Value:
  - Navigate: “URL (обяз.)”
  - Fill: “текст для ввода (обяз.)”
  - AssertText: “ожидаемый текст (обяз.)”
  - Screenshot: “метка/имя (опционально)”
  - Wait/Click/Delay: “(не используется)” (disabled)

**DelayMs:**
- Для всех действий, кроме Delay: “задержка перед шагом”.
- Для Delay: “длительность паузы (мс)”.

**Enable/Disable по Action:**
- Navigate: Selector disabled; Value enabled(required)
- Wait: Selector enabled(required); Value disabled
- Click: Selector enabled(required); Value disabled
- Fill: Selector enabled(required); Value enabled(required)
- AssertText: Selector enabled(required); Value enabled(required)
- Screenshot: Selector enabled(optional); Value enabled(optional)
- Delay: Selector disabled; Value disabled; DelayMs required(>0)

**Inline-ошибки (примеры):**
- “Шаг: Перейти — Value (URL) обязателен”
- “Шаг: Клик — Selector обязателен”
- “Шаг: Пауза — DelayMs должен быть больше 0”

---

### 18.2. A2 ui.snapshot — Targets
**Секция:** Targets (Row-block list)

**Строка цели (Grid):**
- `160 | 3* | 2*`
  1) **Name (TextBox)** ~160 (опц.)
  2) **Url (TextBox)** 3* (обяз.)
  3) **Selector (TextBox)** 2* (опц.; если пусто — снимаем всю страницу)

**Плейсхолдеры:**
- Name: “главная / логин …”
- Url: “https://example.com/page”
- Selector: “селектор элемента (опционально)”

**Inline-ошибки:**
- “Target: Url обязателен”

Модульные опции (не в строке):
- WaitAfterLoadMs (Numeric)
- FullPage (Checkbox) — если ON, Selector в строках можно игнорировать/disabled

---

### 18.3. A3 ui.timing — Targets
**Секция:** Targets (Row-block list)

**Строка цели (Grid):**
- `160 | 4*`
  1) Name (TextBox) ~160 (опц.)
  2) Url (TextBox) 4* (обяз.)

Опции модуля:
- WaitUntil (ComboBox: domcontentloaded/load/networkidle)
- WarmupRuns (Numeric)

---

### 18.4. B1 http.functional — Endpoints + Headers
#### Endpoints
**Строка endpoint (Grid):**
- `140 | 3* | 96`
  1) **Method (ComboBox)** ~140 (GET/POST/PUT/DELETE/PATCH)
  2) **Url (TextBox)** 3* (обяз.)
  3) **Expected (Numeric)** ~96 (дефолт 200)

Плейсхолдер:
- Url: “https://api.example.com/v1/ping”

Inline-ошибка:
- “Endpoint: Url обязателен”

#### Headers (общие для всех endpoints, MVP)
**Строка header (Grid):**
- `220 | 4*`
  1) Key ~220 (обяз.)
  2) Value 4* (обяз.)

Плейсхолдер:
- Key: “Authorization”
- Value: “Bearer …”

---

### 18.5. B2 http.performance — Endpoints + Headers
На MVP достаточно **1 endpoint**, но UI поддерживает список.

**Строка endpoint (Grid):**
- `140 | 4*`
  1) Method (ComboBox) ~140
  2) Url (TextBox) 4* (обяз.)

Headers — как в B1.

---

### 18.6. B3 http.assets — Assets
**Строка asset (Grid):**
- `160 | 3* | 180 | 96 | 110`
  1) Name (TextBox) ~160 (опц.)
  2) Url (TextBox) 3* (обяз.)
  3) ExpectedContentType (TextBox) ~180 (опц.)
  4) MaxSizeKb (Numeric) ~96 (опц.)
  5) MaxLatencyMs (Numeric) ~110 (опц.)

Плейсхолдеры:
- ContentType: “text/css” или “image/png”

Inline-ошибка:
- “Asset: Url обязателен”

---

### 18.7. C1 net.dnsTcpTls — Ports
**Строка порта (Grid):**
- `120 | 2*`
  1) Port (Numeric) ~120 (обяз., 1..65535)
  2) Label/Hint (TextBox) 2* (опц., “https”, “ssh”)

Inline-ошибка:
- “Port: 1..65535”

---

### 18.8. C2 availability — (списков нет)
Модуль не требует списков. Поля формы:
- Type (HTTP/TCP)
- Url/Host
- Port (если TCP)
- IntervalSeconds

---

### 18.9. C3 security.baseline — (списков нет)
Модуль — чек-лист проверок.

---

### 18.10. C4 preflight — (списков нет)
Модуль — чек-лист + target.

---

## 19. Вкладка «Прогоны» — таблица и действия (минимум UX)
**Таблица прогонов (DataGrid допустим здесь, т.к. отдельная вкладка и отдельная прокрутка):**
Колонки:
- DateTime
- TestName
- Module
- Status
- Duration
- Summary (кратко)

Сверху фильтры:
- Search
- Module filter
- Status filter
- Date range (опц.)

Действия для выбранного run:
- Открыть папку
- Открыть HTML
- Открыть report.json
- Копировать RunId
- Повторить запуск (загрузить payload + перейти на соответствующий модуль)

---

## 20. Details pane — Run summary: минимальные метрики (v1.8)
Цель: справа показывать **только то, что реально помогает принять решение**, без перегруза.

### 20.1. Общий каркас Run summary (для всех групп)
Блок “Run summary” состоит из 3 подтем (в указанном порядке):
1) **Identity**
   - TestName (FinalName)
   - Module
2) **State**
   - Status (Idle/Running/Completed/Error/Stopped)
   - Timer (elapsed)
   - Progress (x/y или %)
3) **Last issue (если есть)**
   - Последняя ошибка (1–2 строки)
   - Кнопка **“Показать в логе”**

Общее поведение:
- В Running обновляем значения не чаще чем ~4 раза/сек (UI не должен «дёргаться»).
- “Показать в логе”:
  - разворачивает Log drawer (если свернут)
  - ставит фокус на лог
  - прокручивает к последней строке уровня Error (или к последнему маркеру ошибки)


### 20.2. UI тестирование — набор метрик
Показываем 4–6 значений, в зависимости от модуля.

#### A1 UiScenario
- **Worker/Iteration**: `W{workerId} / Iter {iteration}` (если параллельно)
- **Step**: `Step {i}/{n}` + Action (рус.)
- **Selector (short)**: обрезать до ~60 символов
- **Errors**: `errorsCount` за запуск
- **Screenshots**: `screenshotsCount` (если доступно)

#### A2 UiSnapshot
- **Target**: `target {i}/{n}`
- **Url (short)**
- **Captured**: `capturedCount`
- **Errors**

#### A3 UiTiming
- **Target**: `target {i}/{n}`
- **Samples**: `samplesCount`
- **Last latency**: `lastMs` (или avg на текущем target)
- **Errors**

Примечание UX:
- Если в UI-группе включён Headless, показываем строку “Headless: On”.


### 20.3. HTTP тестирование — набор метрик
#### B1 HttpFunctional
- **Endpoints done**: `done/total`
- **Success/Fail**: `okCount / failCount`
- **Last status**: `lastStatusCode` (если есть)
- **Latency (last)**: `lastMs`

#### B2 HttpPerformance
- **Requests sent**: `sentCount`
- **RPS (current)**: `currentRps`
- **Errors**: `errorsCount` + “%” (если можно)
- **Latency**: `p50 / p95` (если считаем) иначе `avg`.

#### B3 HttpAssets
- **Assets done**: `done/total`
- **Failed**: `failCount`
- **Last**: `lastUrl short`


### 20.4. Сеть и безопасность — набор метрик
#### C1 NetDiagnostics
- **DNS**: `ok/fail` + `resolveMs` (если есть)
- **TCP**: `ok/fail` + `connectMs (last)`
- **TLS**: `ok/fail` + `handshakeMs (last)`
- **Ports done**: `done/total`

#### C2 Availability
- **Checks done**: `done/total` (или elapsed)
- **Up/Down**: `upCount / downCount`
- **Uptime%** (если считаем)
- **Last**: last result + ms

#### C3 SecurityBaseline
- **Checks**: `passed/failed/total`
- **Most important fail**: 1 строка (например “CSP missing”)

#### C4 Preflight
- **Checks**: `passed/failed/total`
- **First fail**: 1 строка


## 21. Artifacts (Details pane) — что показываем и как
Блок “Artifacts” (справа) всегда одинаков:
- Path: `…/runs/{runId}/` (только чтение)
- Кнопки:
  - **Открыть папку** (всегда после старта, когда папка создана)
  - **Открыть HTML** (если HtmlReportEnabled)
  - **Открыть report.json** (после завершения или если файл уже создан)

Дополнительно (read-only строки):
- runId
- startedAtUtc / finishedAtUtc (если есть)


## 22. ScreenshotsPolicy (RunProfile) — точные правила UX
Это важно, чтобы пользователь понимал, **когда появятся файлы** и почему.

### 22.1. Где показываем политику
- Поле **ScreenshotsPolicy** показываем **только в UI тестировании**.
- Значения (рус.):
  - Выкл
  - При ошибке
  - Всегда

### 22.2. Семантика политики (MVP, без раздувания)
- **Выкл**: автоматические скриншоты не делаем.
- **При ошибке**: делаем скриншот **только когда шаг/итерация завершается ошибкой**.
- **Всегда**: делаем скриншот **при ошибке** + **в конце успешного запуска** (1 финальный скрин на run).

Заметка: “Всегда = каждый шаг/каждая итерация” на MVP **не делаем**, чтобы не раздувать папку и не замедлять тест.

### 22.3. Взаимодействие со шагом «Скриншот» в UiScenario
- Шаг **Скриншот** (Action=Screenshot) — это явная команда пользователя.
- Он **всегда делает скриншот**, даже если ScreenshotsPolicy = Выкл.
- Таким образом:
  - Policy управляет *автоматическими* скриншотами.
  - Step Screenshot — *ручной* скриншот.

### 22.4. UI Snapshot
- Модуль UiSnapshot всегда создаёт изображения (по сути это “сам смысл”).
- ScreenshotsPolicy на него **не влияет**.


## 24. Log drawer (v1.9) — уровни, формат, фильтры
Цель: лог должен быть **полезным** и **управляемым** на FullHD, без зависаний.

### 24.1. Уровни (строго)
- **Info** — нормальные события (start/stop, шаги, метрики).
- **Warn** — деградации/пограничные проблемы (таймауты на ожидании, повторные попытки, превышение порога).
- **Error** — ошибка шага/итерации/модуля, приводящая к fail (или к пропуску, если policy SkipStep).

### 24.2. Формат строки лога (единый)
Каждая строка отображается в виде одной строки (перенос по словам разрешён), формат:
- `HH:mm:ss.fff [LEVEL] [ModuleId] (W{worker}/I{iter}) Message`

Правила:
- Worker/Iteration показываем, если применимо. Если нет — не выводим блок.
- ModuleId всегда выводим.
- Message — короткое, без стека. Стек пишем в report.json (если есть).

Примеры:
- `12:03:10.124 [INFO] [ui.scenario] (W1/I3) Step 2/7: Клик #login`
- `12:03:11.912 [WARN] [http.performance] (W4/I12) Timeout on request, retry 1/3`
- `12:03:15.002 [ERROR] [net.dnsTcpTls] DNS resolve failed: host=example.com`

### 24.3. UI элемента Log drawer
Collapsed:
- Одна строка: `[▼/▲] Autoscroll [ ] OnlyErrors [ ] Filter[...] [Copy] [Clear]`
Expanded:
- Список строк (virtualization обязателен)

### 24.4. OnlyErrors
- Если включён, показываем только строки уровня **Error**.
- В режиме OnlyErrors поле Filter всё равно работает.

### 24.5. Filter
- Фильтр применяем к Message и к ModuleId.
- Режим: “contains” (без regex на MVP).
- При наборе текста фильтр обновляется не чаще чем раз в 150–250 мс (debounce).

### 24.6. Autoscroll
- Autoscroll ON по умолчанию.
- Автоскролл работает только если пользователь внизу.

### 24.7. Ограничение объёма
- В памяти держим максимум **10 000 строк**.
- При переполнении удаляем самые старые пачками (например по 500).
- В UI показываем маленькое предупреждение: “Лог усечён до 10 000 строк”.

### 24.8. Copy / Clear
- Copy:
  - если выделено — копируем выделение
  - если нет — копируем всё, что отображается (учитывая фильтр/OnlyErrors)
- Clear:
  - очищает отображение (в памяти) для текущей сессии UI
  - **не удаляет файлы**

### 24.9. Show in log (из Details pane)
Поведение кнопки “Показать в логе”:
1) Развернуть Log drawer, если он collapsed.
2) Снять OnlyErrors=OFF (если включен) — **не снимаем**, если пользователь включил осознанно? (решение ниже)
3) Установить Filter = ModuleId (и, если есть, код ошибки) — чтобы быстро сузить.
4) Прокрутить к последней Error строке.

Принятое решение по пункту (2):
- **OnlyErrors не снимаем автоматически.**
- Если OnlyErrors=ON и Filter пуст — ставим Filter=ModuleId, чтобы пользователь всё равно увидел ошибку.

---

## 25. Вкладка «Прогоны» (History) — Repeat run (v1.9)
Цель: повторить запуск максимально быстро и предсказуемо.

### 25.1. UI на вкладке Прогоны
Сверху:
- Search
- Module filter
- Status filter
- Date range (опц.)

Таблица:
- DateTime
- FinalName
- ModuleId
- Status
- Duration
- Summary

Справа/снизу (actions для выбранного run):
- Открыть папку
- Открыть HTML
- Открыть report.json
- Копировать RunId
- **Повторить запуск**

### 25.2. Повторить запуск — точный сценарий
1) Пользователь выбирает run в таблице.
2) Нажимает **Повторить запуск**.
3) Приложение:
   - читает `report.json` выбранного запуска
   - извлекает:
     - ModuleId
     - Profile snapshot (RunProfile)
     - ModuleSettings payload
     - FinalName/TestName
4) UI переключается:
   - на вкладку соответствующей группы (по ModuleId)
   - выбирает модуль в LeftNav
   - загружает payload в форму:
     - RunProfile заполняется значениями из snapshot
     - ModuleSettings заполняется значениями из payload
   - В TestCase:
     - имя заполняем как `FinalName + "_repeat"` (или предлагаем пользовательское)
     - помечаем как Dirty (не сохранено), пока пользователь не сохранит
5) Фокус ставим на Run Control Row (Start).

### 25.3. Поведение, если report.json отсутствует/повреждён
- Показываем сообщение: “Невозможно повторить запуск: отсутствует report.json”.
- Кнопка Repeat run disabled, если нет report.json.

### 25.4. Безопасность UX
- Повторный запуск всегда начинается **только после явного Start**.
- Авто-запуск при Repeat run запрещён.

---

## 26. XAML-верстка (структурно, без стилей) — что именно делаем
Цель: дать точную схему разметки и binding’ов, чтобы разработчик мог собрать UI без "угадывания".

### 26.1. MainWindow.axaml — каркас
**Ответственность:** общий shell приложения: Header + Tabs + область вкладки + Log drawer (внизу).

Структура (псевдо-XAML):
```xml
<Window>
  <Grid RowDefinitions="Auto,Auto,*,Auto">

    <!-- Row 0: Header -->
    <Grid Grid.Row="0" ColumnDefinitions="*,Auto,Auto,Auto" Margin="{StaticResource PagePadding}">
      <TextBlock Grid.Column="0" Text="WebLoadTester"/>
      <Button Grid.Column="1" Content="Настройки" Command="{Binding OpenSettingsCommand}"/>
      <Button Grid.Column="2" Content="Открыть папку прогонов" Command="{Binding OpenRunsFolderCommand}"/>
      <StackPanel Grid.Column="3" Orientation="Horizontal" Spacing="12">
        <TextBlock Text="DB:"/><TextBlock Text="{Binding DbStatusText}"/>
        <TextBlock Text="TG:"/><ToggleButton IsChecked="{Binding TelegramEnabled}"/>
      </StackPanel>
    </Grid>

    <!-- Row 1: Tabs -->
    <TabControl Grid.Row="1" ItemsSource="{Binding Tabs}" SelectedItem="{Binding SelectedTab}">
      <TabControl.ItemTemplate>
        <DataTemplate>
          <TextBlock Text="{Binding Title}"/>
        </DataTemplate>
      </TabControl.ItemTemplate>
      <TabControl.ContentTemplate>
        <DataTemplate>
          <!-- Каждая вкладка сама отдаёт ViewModel контента -->
          <ContentControl Content="{Binding ContentVm}"/>
        </DataTemplate>
      </TabControl.ContentTemplate>
    </TabControl>

    <!-- Row 2: Tab content -->
    <ContentControl Grid.Row="2" Content="{Binding SelectedTab.ContentVm}"/>

    <!-- Row 3: Log drawer (collapsed/expanded) -->
    <views:LogDrawerView Grid.Row="3" DataContext="{Binding LogDrawer}"/>

  </Grid>
</Window>
```

Примечания:
- Не делаем второй дублирующий “RunControl” в Header. RunControl живёт в Workspace.
- Tabs: UI/HTTP/NetSec/Runs.
- Во время Running: Tabs остаются enabled для просмотра; блокируются только смена модуля и редактирование/сохранение конфигурации.

---

### 26.2. ModuleWorkspaceView.axaml — 3 колонки + один скролл
**Ответственность:** общий рабочий экран для любой “семьи” (UI/HTTP/NetSec): LeftNav + Workspace + Details.

Структура:
```xml
<UserControl>
  <Grid ColumnDefinitions="Auto,5,*,5,Auto" RowDefinitions="*">

    <!-- Column 0: LeftNav -->
    <Grid Grid.Column="0" Width="{Binding LeftNavWidth}" MinWidth="220">
      <Grid RowDefinitions="Auto,*" Margin="{StaticResource PagePadding}">
        <TextBox Grid.Row="0" Watermark="Поиск модуля" Text="{Binding ModuleSearchText}"/>
        <ListBox Grid.Row="1"
                 ItemsSource="{Binding Modules}"
                 SelectedItem="{Binding SelectedModule}"
                 IsEnabled="{Binding IsIdle}">
          <ListBox.ItemTemplate>
            <DataTemplate>
              <TextBlock Text="{Binding DisplayName}"/>
            </DataTemplate>
          </ListBox.ItemTemplate>
        </ListBox>
      </Grid>
    </Grid>

    <!-- Column 1: Splitter -->
    <GridSplitter Grid.Column="1" Width="5"/>

    <!-- Column 2: Workspace (ONE ScrollViewer) -->
    <ScrollViewer Grid.Column="2" VerticalScrollBarVisibility="Auto">
      <StackPanel Margin="{StaticResource PagePadding}" Spacing="{StaticResource SectionSpacing}">

        <!-- Run control row -->
        <views:RunControlView DataContext="{Binding RunControl}"/>

        <!-- TestCase -->
        <views:TestCaseView DataContext="{Binding TestCase}"/>

        <!-- RunProfile -->
        <views:RunProfileView DataContext="{Binding RunProfile}"/>

        <!-- Module settings (polymorphic) -->
        <ContentControl Content="{Binding ModuleSettingsVm}"/>

      </StackPanel>
    </ScrollViewer>

    <!-- Column 3: Splitter -->
    <GridSplitter Grid.Column="3" Width="5"/>

    <!-- Column 4: Details pane (collapsible) -->
    <views:DetailsPaneView Grid.Column="4"
                           Width="{Binding DetailsWidth}"
                           MinWidth="280"
                           DataContext="{Binding Details}"
                           IsVisible="{Binding IsDetailsVisible}"/>

  </Grid>
</UserControl>
```

Примечания:
- Width’ы можно держать в VM (persist in settings).
- IsIdle = !IsRunning.
- В узком окне IsDetailsVisible может быть false; включаем через кнопку “Details ▸” (в Header вкладки или RunControl).

---

### 26.3. RunControlView.axaml — Start/Stop/Status/Progress
```xml
<UserControl>
  <Grid ColumnDefinitions="Auto,Auto,Auto,*,Auto" RowDefinitions="Auto">
    <Button Grid.Column="0" Content="Старт" Command="{Binding StartCommand}" IsEnabled="{Binding CanStart}"/>
    <Button Grid.Column="1" Content="Стоп" Command="{Binding StopCommand}" IsEnabled="{Binding CanStop}"/>
    <TextBlock Grid.Column="2" Text="{Binding StatusText}" Margin="12,0,0,0"/>
    <ProgressBar Grid.Column="3" Value="{Binding ProgressValue}" Maximum="100"/>
    <StackPanel Grid.Column="4" Orientation="Horizontal" Spacing="8">
      <Button Content="Папка" Command="{Binding OpenRunFolderCommand}" IsEnabled="{Binding HasRunFolder}"/>
      <Button Content="HTML" Command="{Binding OpenHtmlReportCommand}" IsEnabled="{Binding HasHtmlReport}"/>
    </StackPanel>
  </Grid>
</UserControl>
```

---

### 26.4. TestCaseView.axaml — Load/Save/SaveAs/Delete
```xml
<UserControl>
  <StackPanel Spacing="8">
    <TextBlock Text="Конфигурация"/>

    <Grid ColumnDefinitions="2*,Auto" RowDefinitions="Auto,Auto,Auto">
      <ComboBox Grid.Row="0" Grid.Column="0" ItemsSource="{Binding Configs}" SelectedItem="{Binding SelectedConfig}"/>
      <Button   Grid.Row="0" Grid.Column="1" Content="Загрузить" Command="{Binding LoadCommand}"/>

      <TextBox  Grid.Row="1" Grid.ColumnSpan="2" Watermark="Имя (обяз.)" Text="{Binding Name}"/>
      <TextBox  Grid.Row="2" Grid.ColumnSpan="2" Watermark="Описание" Text="{Binding Description}" AcceptsReturn="True"/>
    </Grid>

    <StackPanel Orientation="Horizontal" Spacing="8">
      <Button Content="Сохранить" Command="{Binding SaveCommand}" IsEnabled="{Binding CanSave}"/>
      <Button Content="Сохранить как" Command="{Binding SaveAsCommand}" IsEnabled="{Binding CanSaveAs}"/>
      <Button Content="Удалить" Command="{Binding DeleteCommand}" IsEnabled="{Binding CanDelete}"/>
      <TextBlock Text="{Binding DirtyMark}"/>
    </StackPanel>

    <TextBlock Text="{Binding FinalNamePreview}"/>
    <ItemsControl ItemsSource="{Binding ValidationErrors}"/>
  </StackPanel>
</UserControl>
```

---

### 26.5. DetailsPaneView.axaml — Run summary + Artifacts + Telegram + Help
```xml
<UserControl>
  <ScrollViewer VerticalScrollBarVisibility="Auto">
    <StackPanel Margin="{StaticResource PagePadding}" Spacing="12">

      <GroupBox Header="Run summary">
        <StackPanel>
          <TextBlock Text="{Binding IdentityLine}"/>
          <TextBlock Text="{Binding StateLine}"/>
          <TextBlock Text="{Binding MetricLine1}"/>
          <TextBlock Text="{Binding MetricLine2}"/>
          <TextBlock Text="{Binding LastErrorShort}"/>
          <Button Content="Показать в логе" Command="{Binding ShowInLogCommand}" IsEnabled="{Binding HasError}"/>
        </StackPanel>
      </GroupBox>

      <GroupBox Header="Artifacts">
        <StackPanel>
          <TextBox Text="{Binding RunFolderPath}" IsReadOnly="True"/>
          <StackPanel Orientation="Horizontal" Spacing="8">
            <Button Content="Открыть папку" Command="{Binding OpenFolderCommand}" IsEnabled="{Binding HasRunFolder}"/>
            <Button Content="HTML" Command="{Binding OpenHtmlCommand}" IsEnabled="{Binding HasHtml}"/>
            <Button Content="JSON" Command="{Binding OpenJsonCommand}" IsEnabled="{Binding HasJson}"/>
          </StackPanel>
          <TextBlock Text="runId:"/><TextBlock Text="{Binding RunId}"/>
        </StackPanel>
      </GroupBox>

      <GroupBox Header="Telegram">
        <StackPanel>
          <CheckBox Content="Включено" IsChecked="{Binding TelegramEnabled}" IsEnabled="{Binding CanEditTelegram}"/>
          <CheckBox Content="Уведомлять об ошибках" IsChecked="{Binding NotifyOnError}" IsEnabled="{Binding CanEditTelegram}"/>
          <CheckBox Content="Уведомлять об окончании" IsChecked="{Binding NotifyOnFinish}" IsEnabled="{Binding CanEditTelegram}"/>
        </StackPanel>
      </GroupBox>

      <GroupBox Header="Hotkeys">
        <TextBlock Text="F5 — Старт; Shift+F5 — Стоп; Ctrl+L — Лог; Ctrl+S — Сохранить"/>
      </GroupBox>

    </StackPanel>
  </ScrollViewer>
</UserControl>
```

---

### 26.6. LogDrawerView.axaml — collapsed/expanded
**Ключ:** Log drawer всегда присутствует, но имеет 2 состояния.

```xml
<UserControl>
  <Grid RowDefinitions="Auto,Auto" >

    <!-- Control row (always visible) -->
    <Grid RowDefinitions="Auto" ColumnDefinitions="Auto,Auto,Auto,*,Auto,Auto" Margin="{StaticResource PagePadding}">
      <ToggleButton Grid.Column="0" Content="Лог" IsChecked="{Binding IsExpanded}"/>
      <CheckBox     Grid.Column="1" Content="Автоскролл" IsChecked="{Binding AutoScroll}"/>
      <CheckBox     Grid.Column="2" Content="Только ошибки" IsChecked="{Binding OnlyErrors}"/>
      <TextBox      Grid.Column="3" Watermark="Фильтр" Text="{Binding FilterText}"/>
      <Button       Grid.Column="4" Content="Copy" Command="{Binding CopyCommand}"/>
      <Button       Grid.Column="5" Content="Clear" Command="{Binding ClearCommand}"/>
    </Grid>

    <!-- Log list (visible only when expanded) -->
    <Border Grid.Row="1" IsVisible="{Binding IsExpanded}">
      <ListBox ItemsSource="{Binding VisibleLines}" SelectedItem="{Binding SelectedLine}">
        <ListBox.ItemsPanel>
          <ItemsPanelTemplate>
            <VirtualizingStackPanel />
          </ItemsPanelTemplate>
        </ListBox.ItemsPanel>
        <ListBox.ItemTemplate>
          <DataTemplate>
            <TextBlock Text="{Binding RenderedText}" TextWrapping="Wrap"/>
          </DataTemplate>
        </ListBox.ItemTemplate>
      </ListBox>
    </Border>

  </Grid>
</UserControl>
```

Примечания:
- `VisibleLines` уже учитывает OnlyErrors + Filter.
- Лимит 10k строк реализуется в VM.

---

## 27. RowListEditor (универсальный контрол) — API и разметка
Цель: единый контрол для всех списков (Steps/Targets/Endpoints/Headers/Assets/Ports).

### 27.1. API (Bindings)
`RowListEditorViewModel` (не generic в XAML) должен иметь:
- `ObservableCollection<object> Items`
- `object? SelectedItem`
- `ICommand AddCommand`
- `ICommand RemoveCommand`
- `ICommand MoveUpCommand`
- `ICommand MoveDownCommand`
- `ICommand DuplicateCommand` (optional)
- `bool CanRemove/CanMoveUp/CanMoveDown/CanDuplicate`
- `IEnumerable<string> ValidationErrors` (optional, агрегированные)

Почему `object`: в Avalonia DataTemplate выбирается по типу item-VM.

### 27.2. Разметка RowListEditorView.axaml
```xml
<UserControl>
  <StackPanel Spacing="8">

    <!-- Toolbar -->
    <StackPanel Orientation="Horizontal" Spacing="8">
      <Button Content="Добавить" Command="{Binding AddCommand}"/>
      <Button Content="Удалить" Command="{Binding RemoveCommand}" IsEnabled="{Binding CanRemove}"/>
      <Button Content="Вверх" Command="{Binding MoveUpCommand}" IsEnabled="{Binding CanMoveUp}"/>
      <Button Content="Вниз" Command="{Binding MoveDownCommand}" IsEnabled="{Binding CanMoveDown}"/>
      <Button Content="Дублировать" Command="{Binding DuplicateCommand}" IsEnabled="{Binding CanDuplicate}"/>
    </StackPanel>

    <!-- Aggregate errors -->
    <ItemsControl ItemsSource="{Binding ValidationErrors}"/>

    <!-- Rows -->
    <ListBox ItemsSource="{Binding Items}" SelectedItem="{Binding SelectedItem}">
      <ListBox.ItemsPanel>
        <ItemsPanelTemplate>
          <VirtualizingStackPanel />
        </ItemsPanelTemplate>
      </ListBox.ItemsPanel>
      <!-- Row template comes from DataTemplates by item type -->
    </ListBox>

  </StackPanel>
</UserControl>
```

### 27.3. DataTemplates для строк
Для каждого списка делаем item-VM тип и DataTemplate:
- `UiStepRowVm` → template (Action/Selector/Value/DelayMs) с enable/disable
- `SnapshotTargetRowVm` → template (Name/Url/Selector)
- `HttpEndpointRowVm` → template (Method/Url/Expected)
и т.д.

Внутри каждой строки:
- Grid с колонками из v1.7.
- Inline error (TextBlock) под строкой, если item-VM имеет `RowErrorText`.

---

## 28. Минимальный набор ViewModel-контрактов и команд (чтобы UI работал)
Ниже — минимально необходимая модель MVVM. Можно переделывать код смело — это целевой контракт.

### 28.1. AppShellViewModel (MainWindow)
Свойства:
- `ObservableCollection<TabVm> Tabs`
- `TabVm SelectedTab`
- `LogDrawerVm LogDrawer`
- `bool IsRunning` (глобальный индикатор)
- `bool TelegramEnabled`, `string DbStatusText`

Команды:
- `OpenSettingsCommand`
- `OpenRunsFolderCommand`

### 28.2. TabVm
- `string Title`
- `object ContentVm` (обычно `ModuleFamilyVm` или `RunsVm`)

### 28.3. ModuleFamilyVm (UI/HTTP/NetSec)
Свойства:
- `ObservableCollection<ModuleDescriptorVm> Modules`
- `ModuleDescriptorVm SelectedModule`
- `string ModuleSearchText`
- `ModuleWorkspaceVm Workspace`

Правило:
- SelectedModule меняет Workspace.ModuleSettingsVm.

### 28.4. ModuleWorkspaceVm
Свойства:
- `RunControlVm RunControl`
- `TestCaseVm TestCase`
- `RunProfileVm RunProfile`
- `object ModuleSettingsVm` (полиморфный)
- `DetailsVm Details`
- `bool IsRunning`, `bool IsIdle`
- `double LeftNavWidth`, `double DetailsWidth`, `bool IsDetailsVisible`

### 28.5. RunControlVm
Свойства:
- `string StatusText`
- `double ProgressValue` (0..100)
- `bool CanStart`, `bool CanStop`
- `bool HasRunFolder`, `bool HasHtmlReport`

Команды:
- `StartCommand` (F5)
- `StopCommand` (Shift+F5)
- `OpenRunFolderCommand`
- `OpenHtmlReportCommand`

### 28.6. TestCaseVm
Свойства:
- `ObservableCollection<ConfigVm> Configs`
- `ConfigVm? SelectedConfig`
- `string Name`, `string Description`
- `string FinalNamePreview`
- `bool IsDirty`, `string DirtyMark`
- `ObservableCollection<string> ValidationErrors`

Команды:
- `LoadCommand`
- `SaveCommand` (Ctrl+S)
- `SaveAsCommand`
- `DeleteCommand`

### 28.7. RunProfileVm
Свойства:
- `Mode (Iterations/Duration)`
- `int Iterations`, `int DurationSeconds`, `int Parallelism`, `int TimeoutSeconds`, `int PauseBetweenIterationsMs`
- UI-only (если UI группа): `bool Headless`, `ScreenshotsPolicy`

Методы/команды:
- `Validate()` возвращает ошибки

### 28.8. ModuleSettingsVm (для каждого модуля)
Минимальный контракт:
- `IReadOnlyList<string> Validate()`
- `object BuildPayload()` (для сохранения/запуска)
- `void LoadPayload(object payload)`
- Внутри: нужные RowListEditorVm и простые поля.

### 28.9. DetailsVm
Свойства:
- Summary строки (IdentityLine, StateLine, MetricLine1..2, LastErrorShort)
- Artifacts (RunFolderPath, HasHtml/HasJson, RunId)
- Telegram compact (NotifyOnError/NotifyOnFinish + CanEditTelegram)

Команды:
- `ShowInLogCommand`
- `OpenFolderCommand`, `OpenHtmlCommand`, `OpenJsonCommand`

### 28.10. LogDrawerVm
Свойства:
- `bool IsExpanded` (Ctrl+L)
- `bool AutoScroll`, `bool OnlyErrors`, `string FilterText`
- `ObservableCollection<LogLineVm> VisibleLines`

Команды:
- `CopyCommand`, `ClearCommand`

Методы:
- `Append(LogLineVm line)` с лимитом 10k
- `RebuildVisibleLines()` при смене фильтров

---

## 30. Готовое ТЗ для Codex: реализация UI по v2.0 (v2.1)
Это — инструкция для Codex, чтобы он **реализовал новый UI**, не опираясь на текущий внешний вид.

### 30.1. Общие требования (строго)
1) **UI/UX = по этому холсту** (v2.1). Текущий дизайн в проекте игнорировать.
2) **Без декоративных стилей**: не добавлять цвета, радиусы, тени, анимации. Разрешены только spacing/padding.
3) Один вертикальный ScrollViewer в Workspace. Никаких вложенных вертикальных скроллов.
4) Табличные списки **не DataGrid**, а `RowListEditor`.
5) Смена модуля во время Running запрещена, переключение верхних вкладок разрешено (режим просмотра).
6) Никакого автозапуска при Repeat run.

### 30.2. Файлы: что создаём/заменяем
**Создать новые Views (если отсутствуют):**
- `Presentation/Views/Workspace/ModuleWorkspaceView.axaml`
- `Presentation/Views/Workspace/RunControlView.axaml`
- `Presentation/Views/Workspace/TestCaseView.axaml`
- `Presentation/Views/Workspace/RunProfileView.axaml`
- `Presentation/Views/Workspace/DetailsPaneView.axaml`
- `Presentation/Views/Workspace/LogDrawerView.axaml`
- `Presentation/Views/Controls/RowListEditorView.axaml`

**Создать новые ViewModels (или заменить существующие):**
- `Presentation/ViewModels/Shell/AppShellViewModel.cs`
- `Presentation/ViewModels/Shell/TabViewModel.cs`
- `Presentation/ViewModels/Workspace/ModuleFamilyViewModel.cs`
- `Presentation/ViewModels/Workspace/ModuleWorkspaceViewModel.cs`
- `Presentation/ViewModels/Workspace/RunControlViewModel.cs`
- `Presentation/ViewModels/Workspace/TestCaseViewModel.cs`
- `Presentation/ViewModels/Workspace/RunProfileViewModel.cs`
- `Presentation/ViewModels/Workspace/DetailsPaneViewModel.cs`
- `Presentation/ViewModels/Workspace/LogDrawerViewModel.cs`
- `Presentation/ViewModels/Controls/RowListEditorViewModel.cs`
- `Presentation/ViewModels/Controls/LogLineViewModel.cs`

**Обновить MainWindow:**
- `Presentation/Views/MainWindow.axaml` → привести к каркасу v2.0.
- `Presentation/ViewModels/MainWindowViewModel.cs` → заменить на AppShellViewModel или адаптировать.

**Обновить вкладки:**
- `Presentation/Views/Tabs/*Tab.axaml` → каждая вкладка должна использовать общий `ModuleWorkspaceView`.
- `Presentation/ViewModels/Tabs/*TabViewModel.cs` → заменить на TabVm + ModuleFamilyVm.

### 30.3. RowListEditor: обязательная реализация
- Toolbar: Add/Remove/Up/Down/Duplicate.
- Items: virtualization.
- Hotkeys: Ctrl+N, Delete, Ctrl+D, Alt+Up/Alt+Down.
- Поддержка inline ошибок (RowErrorText у item-VM) + aggregate errors.

### 30.4. Перевод модульных DataGrid в RowListEditor
Списки, которые обязательно перевести:
- UiScenario Steps
- UiSnapshot Targets
- UiTiming Targets
- HttpFunctional Endpoints + Headers
- HttpPerformance Endpoints + Headers
- HttpAssets Assets
- NetDiagnostics Ports

Для каждого списка:
- создать item-VM (например `UiStepRowVm`) и DataTemplate по v1.7.

### 30.5. Лог (LogDrawer) — обязательная реализация
- Уровни Info/Warn/Error.
- Формат строки как в v1.9.
- Лимит 10k строк.
- OnlyErrors + Filter (debounce).
- ShowInLogCommand (из Details) — разворачивает лог, ставит фокус, фильтрует ModuleId.

### 30.6. Repeat run (Runs tab)
- Вкладка Прогоны: таблица запусков + кнопка Repeat run.
- Repeat run:
  - читает report.json
  - заполняет RunProfile + ModuleSettings
  - переключает вкладку и модуль
  - создаёт имя `FinalName_repeat`
  - НЕ запускает автоматически.

### 30.7. Порядок работ (рекомендуемый)
1) Реализовать AppShell + MainWindow (Header/Tabs/Log drawer).
2) Реализовать `ModuleWorkspaceView` (3 колонки + scroll + splitters).
3) Реализовать RunControl/TestCase/RunProfile/DetailsPane/LogDrawer View+VM.
4) Реализовать `RowListEditor`.
5) Перевести UiScenario на row-list.
6) Перевести остальные списки.
7) Реализовать Runs tab + Repeat run.
8) Ручная проверка по чек-листу.

### 30.8. Definition of Done (критерии готовности)
Считаем задачу выполненной, если:
- Окно соответствует wireframe v1.6.
- Workspace имеет ровно один вертикальный ScrollViewer.
- Все списки (steps/targets/endpoints/assets/ports) работают через RowListEditor.
- Running блокирует LeftNav и редактирование; верхние Tabs остаются доступными для просмотра.
- Лог работает (OnlyErrors, Filter, autoscroll, лимит 10k).
- Details pane показывает summary/артефакты и "Show in log".
- Repeat run подставляет данные, но не запускает.

### 30.9. Чек-лист ручной проверки (минимум)
1) UI-группа: выбрать UiScenario → добавить 5 шагов → переставить → дублировать → удалить.
2) Проверить динамику полей по Action (Navigate/Delay etc.).
3) Нажать Start → во время Running переключение вкладки доступно (просмотр), смена модуля запрещена.
4) Спровоцировать ошибку шага → Details “Показать в логе” ведёт к ошибке.
5) Включить OnlyErrors, поставить Filter, проверить Copy.
6) Перейти во вкладку Прогоны → выбрать run → Repeat run → должен подставить параметры и перейти на модуль.

---

## 31. Следующая итерация (v2.2)
- Подготовить «Codex Prompt» (одним сообщением) на основе ТЗ v2.1: кратко, но максимально точно.
- Опционально: выделить работу на 2–3 подзадачи (если Codex падает по объёму).

