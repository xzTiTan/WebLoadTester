# Правила Codex и журнал изменений — WebLoadTester

**Версия:** v2.15 16.02.2026

## 1. Режим работы (обязательный)
1) Перед правками — прочитать `01–03` (и при необходимости `05–07`).
2) Любое изменение: **анализ → план → точечные правки**.
3) Минимально-инвазивно: не переписывать архитектуру «ради красоты».
4) Любая правка docs → поднять версию/дату в шапке и добавить запись в журнал.

## 2. Guardrails против типовых ошибок Avalonia/XAML (обязательный блок)
**Запрещено в Avalonia/XAML:**
- `SetterTargetType` (WPF-паттерн).
- Атрибут `Mode` в `<FluentTheme ... Mode=...>`.
- `ElementName='\"Root\"'` (кавычки внутри значения).
- `WrapPanel Spacing` (если версия Avalonia не поддерживает).
- Ручное добавление `TargetFrameworkAttribute`/дубликатов Assembly attributes.

**Требования к XAML/Bindings:**
- Для CompiledBinding всегда задавать `x:DataType` на `UserControl` и `DataTemplate`.
- Не полагаться на `DataContext` типа `object?`.
- В `DataTemplate` помнить: контекст — элемент коллекции, а не VM окна.

## 3. Guardrails против типовых ошибок SQLite
- В SQL-командах не оставлять параметр со значением `null` (использовать `DBNull.Value`).
- При nullable полях (например, `FinishedAt`) — передавать `DBNull.Value`.

## 4. Проверка готовности (acceptance для PR)
- `dotnet clean`
- `dotnet build -c Release`
- `dotnet test -c Release` (если есть тестовый проект)
- Smoke из `05_TEST_PLAN_AND_TRACEABILITY.md`

## 5. Что делать при конфликте docs
Если обнаружены разночтения:
1) фиксируем, где конфликт (файл+раздел),
2) выбираем приоритет по правилу в `01_CANON.md`,
3) синхронизируем остальные документы и код.

## 6. Журнал изменений
### v2.15 16.02.2026
- Исправлена ошибка компиляции CS1009 в `Modules/UiScenario/UiScenarioModule.cs`: regex-литерал санитайза имени файла переведён на verbatim-строку (`@"[^a-zA-Z0-9_-]+"`), чтобы убрать нераспознанную escape-последовательность.
- Проверены проектные ссылки для устранения CS0006: в `WebLoadTester.Tests` подтверждён `ProjectReference` на `..\WebLoadTester.csproj`, в основном проекте отсутствуют настройки, отключающие `ProduceReferenceAssembly`; после исправления CS1009 сборка должна восстановиться в окружении с установленным .NET SDK.

### v2.14 16.02.2026
- Реализованы рабочие MVP-модули семейства UI Testing: `A2 ui.snapshot` и `A3 ui.timing` с запуском через Playwright persistent context (`runs/<RunId>/profile/`) и корректной записью результатов в общий run pipeline.
- `ui.snapshot`: поддержаны Targets (`Url/Selector/Name`), `WaitUntil`, `TimeoutSeconds`, `FullPage`, optional `Viewport`; скриншоты сохраняются в `runs/<RunId>/screenshots/` с именами `snap_{index}_{name}_{timestamp}.png`, в результаты добавляются `ScreenshotPath` и `DetailsJson`; ошибки по целям обрабатываются в continue-on-error режиме.
- `ui.timing`: поддержаны Targets URL, `WaitUntil`, `TimeoutSeconds`; для каждой цели снимаются total timings и best-effort navigation метрики (`performance.getEntriesByType('navigation')`), сериализуются в `DetailsJson`; ошибки по целям не прерывают прогон.
- Для A2/A3 обновлены SettingsViewModels/Views (табличные редакторы целей + кнопки `+ / ↑ / ↓ / Удалить`), добавлен RU-конвертер для `WaitUntil`; вложенные `ScrollViewer` в карточках не добавлялись.
- Расширены сериализация отчётов/RunItems: `detailsJson` теперь пробрасывается и для `RunResult`/`TimingResult`.
- Обновлены README/AGENTS и якорные docs (`02`, `05`) для отражения реализованных A2/A3 и smoke-проверок.

### v2.13 16.02.2026
- Реализован MVP модуля `ui.scenario` по Variant B: шаги `Action + Selector + Value + DelayMs`, валидация сценария до запуска и выполнение через Playwright persistent context (`runs/<RunId>/profile/`).
- Для `ui.scenario` добавлены действия `Переход / Ожидание элемента / Клик / Ввод текста / Проверка текста / Скриншот / Пауза`, обработка шагов в режиме Continue-on-error и формирование `StepResult` со `ScreenshotPath` и `DetailsJson`.
- Реализована миграция старого формата шагов `Selector + Text` в Variant B при загрузке/валидации/выполнении (`Text -> Value`, пустой Text -> Click, заполненный Text -> Fill).
- Обновлён UI редактор шагов `UI сценарий` (RU-лейблы, редактирование Variant B, кнопки добавить/удалить/перемещение) без вложенных `ScrollViewer`.
- Добавлены RU-конвертеры отображения для Action шагов и `ScreenshotsPolicy` в RunProfile UI.

### v2.12 16.02.2026
- UI-A1: скорректированы базовые отступы кнопок (`Button` и `Button.link`), чтобы вертикальное выравнивание текста оставалось стабильным на всех кнопках тулбаров.
- UI-A2/A5: в `MainWindow` и `ModuleWorkspace` убраны избыточные `Margin` у action-элементов в пользу `Spacing`, уменьшены межкарточные интервалы до 12, добавлены `ClipToBounds`/ellipsis для заголовков карточек и блока артефактов.
- UI-A3/A4/A6: сохранён полноширинный блок `RunProfile`, удалён внутренний вложенный scroll в блоке артефактов (остаётся один scroll рабочей области вкладки); `SettingsWindow` оставлен в MVP-формате единого скролла с секциями «Пути хранения» и «Telegram».
- UI-A7: добавлена единая агрегация ошибок запуска в `MainWindowViewModel` (подписки на изменения настроек/конфига/профиля + `ReevaluateStartAvailability`), `StartCommand` теперь стабильно блокируется при ошибках валидации.
- UI-A8: унифицирован лимит Duration до 60 секунд через общий `RunProfileLimits` (оркестратор, предупреждения VM и `NumericUpDown.Maximum`).

### v2.11 15.02.2026
- Переразмечена верхняя панель `ModuleWorkspace` в pinned-формат по строкам (`Row0` прогресс+статус+действия, `Row1` список модулей, `Row2` заголовок и описание), что устранило наложения и «прыжки» блоков при ширине 960–1400.
- Карточка «Параметры запуска» перенесена на всю ширину рабочей области (`Grid.ColumnSpan=2`) отдельной строкой, убраны «дыры» в правой части сетки.
- Стабилизированы отступы action-элементов (убраны лишние нижние margin в toolbar-блоках MainWindow/ModuleWorkspace/RunsTab), улучшено визуальное выравнивание без изменения MVVM-логики.

### v2.10 15.02.2026
- Скорректирована геометрия кнопок и центровка текста: в базовом стиле `Button` зафиксированы `HorizontalContentAlignment/VerticalContentAlignment=Center`, увеличен вертикальный `Padding`; те же выравнивания заданы для `Button.link`.
- Убраны лишние вертикальные отступы у toolbar-кнопок в `ModuleWorkspace`, что стабилизировало вертикальный ритм и исключило визуальные «провалы».
- В `ModuleWorkspace` удалена пустая промежуточная строка корневого `Grid` (`RowDefinitions` приведены к `Auto,*`), прокрутка перенесена в актуальную строку, а правая колонка «Настройки модуля» избавлена от лишней внешней карточки (`section`), чтобы убрать эффект «карточка в карточке».
- Для строки прогресса добавлено безопасное усечение (`TextTrimming`, `MaxLines=1`) для предотвращения наложения длинного текста статуса.

### v2.9 15.02.2026
- Документация приведена к консистентному набору файлов: добавлен `docs/00_INDEX.md` с картой 01–08 и рекомендуемым порядком чтения.
- Добавлен единый сводный документ `docs/08_FULL_SOFTWARE_DESCRIPTION.md` (назначение, архитектура, пайплайн прогона, модули, UI, ограничения MVP, roadmap).
- Исправлены ссылки в `README.md` и `AGENTS.md` на реально существующие файлы документации.

### v2.8 15.02.2026
- Исправлена компоновка `ModuleWorkspace`: задана явная разбивка по `Grid.Row` в верхней панели, убрано наложение строки «Модули» на прогресс/статусы и стабилизирован header-блок конфигурации (ellipsis + clip).
- Убраны ложная навигация в `SettingsWindow` и двойной скролл в `MainWindow`; прокрутка оставлена внутри рабочих областей вкладок.
- Устранены конфликты элементов форм: карточка «Конфигурация» закреплена по верхнему краю, дублирующий `Headless` в профиле удалён, булевы поля в профиле запуска и Telegram переведены на `ToggleSwitch`, увеличена высота log drawer.
- Актуализированы версии в `README.md` и `AGENTS.md`.

### v2.7 15.02.2026
- Исправлены ключевые UI-дефекты компоновки: убран жёсткий cap ширины полей, переработана адаптивность фильтров Runs и выравнивание действий в Settings без «магических» отступов.
- Добавлены стили segmented-bar для переключателя модулей (pill/chip visual state selected/unselected) и усилена консистентность action-групп при ресайзе.
- Актуализированы версии в `README.md` и `AGENTS.md`.

### v2.6 12.02.2026
- Обновлены UI-макеты shell/workspace/runs/settings под light-дизайн: карточная компоновка, pill-tabs/chips, единый drawer лога.
- Усилены дизайн-токены и базовые стили контролов для единообразной визуальной системы Avalonia 11.
- Обновлены `README.md` и `AGENTS.md` до версии v2.6 12.02.2026.

### v2.5 11.02.2026
- Сконсолидированы якорные документы до **8 файлов** (README + 7 docs), убраны дубли и битые ссылки.
- Уточнены guardrails: добавлен отдельный блок по SQLite `DBNull.Value` и актуализированы XAML-запреты.
- Актуализировано описание последних стабилизаций: pre-check перед стартом, защита от NRE в конфиг-VM, фиксы SQLite insert.

### v2.4 11.02.2026
- Ранний pre-check перед стартом: `_orchestrator.Validate(...)` вызывается до `IsRunning=true`, ошибки отображаются в `StatusText` и `StatusMessage`.
- Защита от NRE при сохранении/старте: `RunProfile` инициализируется до построения `ModuleItemViewModel`, в VM добавлены null-guards.

### v2.3 11.02.2026
- Удалён `ProfilesDirectory` из настроек приложения и UI; служебный путь профилей фиксирован как `DataDirectory/profiles`.

### v2.2 11.02.2026
- Введён `ModuleCatalog` с `ModuleSuffix`, имя конфигурации всегда `UserName_ModuleSuffix`.
- Стабилизирован compiled binding в HTTP модулях через `x:Static ...MethodOptions`.

### v2.1 11.02.2026
- CI lint в `.github/workflows/ci.yml` сделан точечным (проверяет только `Mode` внутри FluentTheme).
