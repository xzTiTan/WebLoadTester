# Техническая спецификация — архитектура, модули, данные, отчёты (WebLoadTester)

**Версия:** v1.0 02.02.2026

## 1. Архитектура и логика выполнения (перенос из 03)

Архитектура, связи, логика выполнения и последовательность работы
Версия: v1.1 24.01.2026

1) Общая архитектура (слои)
Система модульная: Core управляет жизненным циклом прогона, Modules выполняют проверки, Storage хранит данные, Reporting формирует отчёты/артефакты, UI отображает и управляет.

1.1 Presentation (UI, Avalonia + MVVM)
- 4 вкладки верхнего уровня: UI тестирование / HTTP тестирование / Сеть и безопасность / Прогоны.
- Единый шаблон экрана модуля: секции сверху вниз, вертикальная прокрутка.
- Управление тестами: ComboBox сохранённых тестов + Загрузить/Сохранить + Название/Описание.
- Управление профилем: выбор/сохранение RunProfile (шаблон).
- Управление прогоном: Start/Stop/Cancel, прогресс, итог, детали, артефакты, лог.
- Вкладка “Прогоны”: фильтры, детали, открыть отчёты/папку, копировать RunId, повторить запуск.

1.2 Core (Orchestrator / Execution Engine)
- принимает TestCaseSettings + RunProfile,
- валидирует настройки,
- создаёт RunId и запись TestRun (Running) в БД,
- создаёт папку runs/{RunId}/,
- (опционально) выполняет preflight,
- запускает workers (Parallelism) в режиме Iterations/Duration,
- собирает ModuleResult (summary/details/artifacts),
- завершает прогон: статус + сохранение результатов + запуск Reporting,
- (опционально) отправляет Telegram уведомление.

1.3 Modules (10 модулей)
Каждый модуль реализует единый контракт:
- Validate(settings) -> список ошибок
- ExecuteAsync(settings, runContext, ct) -> ModuleResult
Модули не зависят от UI. Они возвращают результаты в общем формате.

1.4 Storage (SQLite + runs/)
- SQLite: тесты, версии, профили, прогоны, детализация, ссылки на артефакты.
- Файлы: runs/{RunId}/report.json, report.html (опц.), screenshots/, logs/.

1.5 Reporting (формирование отчётов и артефактов)
- формирует report.json (всегда),
- формирует report.html (опционально),
- сохраняет логи и прочие артефакты,
- записывает ссылки на артефакты в БД.

1.6 Integrations (Telegram)
- отправка краткого статуса прогона,
- ошибка Telegram не меняет статус прогона (фиксируется в БД/логах отдельно).

2) Единые сущности и термины
2.1 TestCase
- Id, Name, Description, ModuleType
- CurrentVersion
- Versions: payload JSON (настройки модуля, процедура, ожидания)

2.2 RunProfile
- Parallelism, Iterations/Duration, Timeouts
- Headless (UI), ScreenshotsPolicy (UI)
- HtmlReportEnabled, TelegramEnabled
- Фиксация snapshot в TestRun

2.3 TestRun
- RunId
- TestCaseId + версия теста
- ProfileSnapshotJson
- Status, StartedAt, FinishedAt
- SummaryJson (итоговые метрики)

2.4 ModuleResult
- Summary (метрики/итог)
- Details (элементы проверки: шаги/endpoint’ы/ассеты/порты/проверки)
- Artifacts (список файлов)

3) Статусы (формальные определения)
- Success: все элементы проверки прошли согласно ожиданиям.
- Failed: критическая ошибка или останов по политике, не позволяющий корректно завершить процедуру.
- Partial: прогон завершился, но часть элементов не прошла при разрешённой политике продолжения.
- Cancelled: пользователь отменил выполнение.

4) Последовательность выполнения прогона (сквозной сценарий)
Шаг 1: выбор модуля, теста и профиля.
Шаг 2: Start → Validate → создание RunId, TestRun=Running, папка runs/{RunId}/.
Шаг 3: (опционально) Preflight (либо модуль C4 отдельно, либо этап по чекбоксу профиля).
Шаг 4: Running → запуск workers (Parallelism) в режиме Iterations/Duration.
Шаг 5: Сбор результатов → UI получает прогресс и лог.
Шаг 6: Saving/Reporting → запись в БД, формирование report.json (+ report.html опц.), сохранение артефактов.
Шаг 7: (опционально) Telegram → отправка статуса; при ошибке фиксируется событие.
Шаг 8: Done → UI показывает итог/детали; запись доступна во вкладке “Прогоны”.

---

## 2. Каталог модулей (10 шт.) (перенос из 04)

Каталог модулей (10 шт.) — русские названия, цель, полезность, специфический вход/выход и отображение в UI
Версия: v1.1 24.01.2026

Общий шаблон для всех модулей
Единый вход (для любого модуля):
- TestCaseSettings: специфичные настройки модуля (URL, шаги, endpoint’ы, порты и т.д.)
- RunProfile: параметры исполнения (Parallelism, Iterations/Duration, таймауты, политики отчёта/артефактов, Telegram)
Единый выход:
- ModuleResult: Summary + Details + Artifacts
- Итоговый статус: Success / Failed / Partial / Cancelled
- Отчёты/артефакты привязаны к RunId (JSON всегда; HTML опционально)

Семейство A — UI тестирование (Playwright)

A1. “UI-сценарии (клики и ввод текста)”
Цель: воспроизводимо выполнить пользовательский сценарий, подтвердить работоспособность ключевых действий в UI.
Полезно: доказательная база “как у пользователя”; ускорение анализа и эскалации подрядчику.
Специфический вход:
- StartUrl
- Список шагов: Click/InputText/Wait (selector, value, timeout)
- StepErrorPolicy (StopOnError / Continue)
- Для UI: Headless, ScreenshotsPolicy
Процедура: открыть страницу → выполнить шаги → фиксировать время/статус каждого шага → скриншоты по политике.
Специфический результат:
- Details: таблица шагов (№, тип, selector, статус, длительность, ошибка)
- Artifacts: скриншоты (на ошибке/всегда), лог
UI: “доска шагов” (таблица) + Добавить/Удалить/Вверх/Вниз, итог и список артефактов.

A2. “UI-снимки (скриншоты страниц)”
Цель: быстро зафиксировать визуальное состояние страниц и факт открытия.
Полезно: простая доказательная база (скриншоты), контроль “открывается/не открывается”.
Специфический вход:
- Список URL
- ReadyState/условие готовности
Процедура: открыть URL → дождаться ready-state → сделать скриншот → записать время и статус.
Специфический результат:
- Details: таблица URL (status, loadTime, error)
- Artifacts: набор скриншотов
UI: список URL + результаты + быстрый доступ к скриншотам.

A3. “UI-тайминги (скорость загрузки)”
Цель: измерить производительность UI (время загрузки/готовности).
Полезно: поиск деградаций и сравнение “до/после”.
Специфический вход:
- Список URL
- ReadyState
- Повторы/длительность
Процедура: серия измерений → агрегация статистики.
Специфический результат:
- Summary: avg/min/max; p95/p99 — только если достаточно измерений (например N≥20)
- Details: метрики по URL + ошибки
UI: таблица метрик и итоговая сводка.

Семейство B — HTTP тестирование (HttpClient)

B1. “HTTP функциональные проверки (эндпоинты)”
Цель: проверить API/ресурсы на корректность статусов и базовых условий.
Полезно: быстрый smoke; фиксирует 500 и типовые ошибки после изменений.
Специфический вход:
- Список endpoint’ов (method, url, expectedStatus, optional: containsText)
Процедура: выполнить запросы → проверить ожидания → измерить latency.
Специфический результат:
- Details: таблица endpoint’ов (pass/fail, code, latency, error)
UI: таблица endpoint’ов + добавить/удалить + фильтр “только ошибки”.

B2. “HTTP производительность (контролируемая проверка)”
Цель: оценить задержки и стабильность на HTTP-уровне при параллельных запросах.
Полезно: контролируемая эксплуатационная проверка без атак и “флуда”.
Специфический вход:
- endpoint(ы)
- Parallelism, Iterations/Duration, timeouts
Процедура: параллельные запросы workers → сбор latency/ошибок → агрегация.
Специфический результат:
- Summary: avg; p95/p99 при N≥20; % ошибок; распределение кодов
- Details: агрегаты по endpoint’ам
UI: сводка метрик + таблица распределения статусов.

B3. “HTTP ассеты (статические ресурсы)”
Цель: проверить доступность и базовые параметры ассетов (css/js/images).
Полезно: выявляет причины “страница сломалась/не грузится UI”.
Специфический вход:
- Список URL ассетов
- Optional: expectedContentType, maxLatency, maxSize
Процедура: запросы ресурсов → фиксация статуса/типа/размера/времени.
Специфический результат:
- Details: таблица ассетов (pass/fail + причина)
UI: список ассетов и результаты.

Семейство C — Сеть и безопасность

C1. “Сетевая диагностика (DNS/TCP/TLS)”
Цель: локализовать уровень сетевой проблемы и/или TLS неисправности.
Полезно: быстро объясняет “не открывается”, “сертификат истёк”.
Специфический вход:
- Host/URL
- Порты (80/443 по умолчанию + возможность добавлять/удалять)
- Флаги: DNS/TCP/TLS/сертификат
Процедура: DNS resolve → TCP connect → TLS handshake → проверка сертификата.
Специфический результат:
- Details: результаты по уровням и портам (OK/WARN/FAIL + причина)
UI: карточка итогов + детализация по портам + рекомендации.

C2. “Монитор доступности”
Цель: наблюдать доступность во времени и фиксировать интервалы недоступности.
Полезно: подтверждает “флаппинг”, простои, устойчивость.
Специфический вход:
- Цель (HTTP или TCP), интервал, длительность
Процедура: периодические проверки → запись результатов.
Специфический результат:
- Summary: uptime%, количество инцидентов
- Details: интервалы недоступности
UI: таблица интервалов и сводка.

C3. “Базовые проверки безопасности (baseline без атак)”
Цель: проверить базовую корректность конфигурации (без атакующих действий).
Полезно: выявляет грубые misconfig: заголовки/редиректы/TLS.
Специфический вход:
- URL
- Чек-лист baseline проверок
Процедура: запросы и анализ результатов.
Специфический результат:
- Details: список проверок (OK/WARN/FAIL) + рекомендации
UI: таблица проверок + колонка “рекомендация”.

C4. “Предпроверка готовности (preflight readiness)”
Цель: быстро определить “готово ли” запускать более тяжёлые проверки.
Полезно: предотвращает бессмысленные прогоны при явной сетевой проблеме.
Специфический вход:
- URL/host
- Набор минимальных проверок (DNS/TCP/TLS/HTTP)
Процедура: быстрый прогон минимальных проверок.
Специфический результат:
- Summary: Ready/Not Ready
- Details: причины и рекомендации
UI: плашка Ready/Not Ready + список причин.

---

## 3. База данных SQLite: структура, связи, версии (перенос из 05)

База данных (SQLite): структура, связи, версии и ожидаемое поведение
Версия: v1.1 24.01.2026

1) Зачем БД
БД нужна для соответствия требованиям ВКР и для практической ценности продукта:
- тест должен хранить исходные данные, процедуру и ожидаемый результат;
- тесты должны переиспользоваться и версионироваться;
- история прогонов должна быть доступна для анализа и повторного запуска.

2) Выбор решения хранения
- SQLite (файл) — основная БД (минимальная сложность, без серверной инфраструктуры).
- Файловая система — для артефактов /runs/{RunId}/...

3) Минимальная схема (достаточная для 10 модулей)
3.1 TestCases
- Id, Name, Description, ModuleType
- CreatedAt, UpdatedAt, CurrentVersion

3.2 TestCaseVersions
- Id, TestCaseId, VersionNumber, ChangedAt, ChangeNote
- PayloadJson (настройки модуля и процедура в JSON)

3.3 RunProfiles
- Id, Name
- Parallelism, Mode (Iterations/Duration), Iterations, DurationSeconds
- TimeoutsJson (или поля по умолчанию)
- Headless, ScreenshotsPolicy, HtmlReportEnabled, TelegramEnabled
- Optional: PreflightEnabled

3.4 TestRuns
- RunId
- TestCaseId, TestCaseVersion
- ProfileSnapshotJson (фактически использованные параметры)
- StartedAt, FinishedAt
- Status (Success/Failed/Partial/Cancelled)
- SummaryJson (итоговые метрики)

3.5 RunItems (детализация)
- Id, RunId
- ItemType (Step/Endpoint/Asset/NetCheck/BaselineCheck/MonitorTick)
- ItemKey (например Step#3, URL, Host:Port)
- Status, DurationMs, ErrorMessage
- Optional: ExtraJson (например код ответа, content-type и т.д.)

3.6 Artifacts
- Id, RunId
- ArtifactType (JsonReport/HtmlReport/Screenshot/Log/Other)
- RelativePath, CreatedAt

3.7 TelegramNotifications (опционально)
- Id, RunId
- SentAt
- Status (Sent/Failed)
- ErrorMessage

4) Версионность тестов (что это значит для пользователя)
- Пользователь редактирует параметры теста и нажимает “Сохранить”.
- Создаётся новая запись TestCaseVersions (новая версия).
- CurrentVersion в TestCases обновляется.
- При запуске в TestRuns фиксируется версия, чтобы прогон был воспроизводимым.

5) Путь к файлу SQLite и папке runs/
- Путь к SQLite задаётся в “Настройках” приложения (конфигурируемо).
- Рекомендуемый дефолт: каталог данных приложения (AppData) + подпапка /data.
- Папка runs/ по умолчанию рядом с выбранным каталогом данных, но может быть вынесена в настройку (опционально).

6) Retention (политика хранения)
- Артефакты физически лежат в /runs/{RunId}/...
- БД хранит ссылки.
- Минимальная реализация: ручная кнопка “Удалить прогоны старше N дней” (опционально, достаточно для ВКР).

---

## 4. Отчёты, артефакты, Telegram (перенос из 07)

Отчёты, артефакты, Telegram: форматы, логика и ожидаемые результаты
Версия: v1.1 24.01.2026

1) Принцип “каждый прогон оставляет след”
После каждого запуска должны быть:
- запись TestRun в БД (RunId),
- report.json (всегда),
- логи и прочие артефакты (при наличии),
- report.html (опционально),
- Telegram статус (опционально).

2) Файловая структура прогонов
/runs/{RunId}/
  report.json
  report.html (опционально)
  /screenshots/...
  /logs/run.log
  (прочие артефакты)

3) JSON отчёт — минимально достаточная структура
3.1 run
- runId, startedAt, finishedAt, status
- moduleType, moduleNameRu
- testName, testCaseId, testCaseVersion

3.2 environment (для воспроизводимости)
- os
- appVersion
- machineName (если доступно)

3.3 profile (snapshot фактически использованных параметров)
- parallelism, mode (iterations/duration), iterations/durationSeconds
- timeouts
- headless, screenshotsPolicy
- htmlReportEnabled, telegramEnabled
- preflightEnabled (если применялось)

3.4 summary
- totalDurationMs
- totalItems, failedItems
- ключевые метрики (avg; p95/p99 при наличии достаточного N)

3.5 details
- список элементов проверки (Step/Endpoint/Asset/NetCheck/…)
- каждый элемент: key, status, durationMs, errorMessage, extra (опционально)

3.6 artifacts
- список: type, relativePath

4) HTML отчёт (опционально)
Назначение: удобное чтение руководителем/заказчиком.
Содержимое:
- краткая сводка (статус, длительность, ошибки, ключевые метрики)
- список проблемных элементов
- ссылки на артефакты

5) Логи
- UI показывает live-лог.
- После завершения лог сохраняется в /runs/{RunId}/logs/run.log.
- Лог должен фиксировать стадии: validate → preflight → running → saving/reporting → done.

6) Telegram уведомление
- формат: тест + модуль + итог + длительность + ошибки + ключевая метрика (если есть) + RunId
- ошибка Telegram не меняет статус прогона; фиксируется как отдельное событие в БД/логах.

---

## 5. Минимальные “контракты” между слоями (добавлено)

> Цель раздела: дать формулировки, которые потом легко переносить в ВКР и в промпты для Codex.

### 5.1 Контракт выполнения модуля
**Вход:** (TestCaseSettings + RunProfileSnapshot)  
**Выход:** (ModuleResult + RunItems + Artifacts + SummaryJson)

### 5.2 Контракт хранения
- UI и Modules **не знают** о SQLite напрямую.
- Работа с БД идёт через Storage-слой (репозитории/сервисы).
- Файлы артефактов лежат в `/runs/{RunId}/`, в БД хранится ссылка (RelativePath).

### 5.3 Контракт отчётности
- Reporting строится **только** из данных прогона: TestRun + RunItems + Artifacts.
- JSON отчёт пишется всегда; HTML — если включено в профиле.
