<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="clr-namespace:WebLoadTester.Presentation.ViewModels"
             x:Class="WebLoadTester.Presentation.Views.Tabs.RunsTab"
             x:DataType="vm:RunsTabViewModel">
    <ScrollViewer VerticalScrollBarVisibility="Auto">
        <Grid RowDefinitions="Auto,*" RowSpacing="16">
            <Border Grid.Row="0" Classes="section">
                <Grid ColumnDefinitions="*,Auto" ColumnSpacing="16" RowDefinitions="Auto,Auto" RowSpacing="12">
                    <TextBlock Grid.Row="0" Grid.ColumnSpan="2" Text="Фильтры" Classes="section-title" />
                    <Grid Grid.Row="1" ColumnDefinitions="*,*,*,*,*" ColumnSpacing="12">
                        <StackPanel Spacing="4">
                            <TextBlock Text="Модуль" Classes="muted" FontSize="12" />
                            <ComboBox ItemsSource="{Binding ModuleFilterOptions}"
                                      SelectedItem="{Binding SelectedModuleType, Mode=TwoWay}" />
                        </StackPanel>
                        <StackPanel Grid.Column="1" Spacing="4">
                            <TextBlock Text="Статус" Classes="muted" FontSize="12" />
                            <ComboBox ItemsSource="{Binding StatusFilterOptions}"
                                      SelectedItem="{Binding SelectedStatus, Mode=TwoWay}" />
                        </StackPanel>
                        <DatePicker Grid.Column="2" SelectedDate="{Binding FromDate, Mode=TwoWay}" />
                        <DatePicker Grid.Column="3" SelectedDate="{Binding ToDate, Mode=TwoWay}" />
                        <TextBox Grid.Column="4" Watermark="Поиск по RunId / модулю" Text="{Binding SearchText, Mode=TwoWay}" />
                    </Grid>
                    <Button Grid.Row="1" Grid.Column="1" Content="Применить" Classes="primary" Command="{Binding RefreshCommand}" />
                </Grid>
            </Border>

            <Grid Grid.Row="1" ColumnDefinitions="1.2*,*" ColumnSpacing="16">
                <Border Grid.Column="0" Classes="section">
                    <Grid RowDefinitions="Auto,*" RowSpacing="8">
                        <Grid ColumnDefinitions="*,Auto">
                            <TextBlock Text="Список прогонов" Classes="section-title" />
                            <Border Grid.Column="1" Classes="badge">
                                <TextBlock Text="Sort: newest" FontSize="12" />
                            </Border>
                        </Grid>

                        <DataGrid Grid.Row="1"
                                  ItemsSource="{Binding Runs}"
                                  SelectedItem="{Binding SelectedRun, Mode=TwoWay}"
                                  Classes="list-min-240"
                                  AutoGenerateColumns="False">
                            <DataGrid.Columns>
                                <DataGridTextColumn Header="RunId" Binding="{Binding RunId}" Width="2*" />
                                <DataGridTextColumn Header="Started" Binding="{Binding StartedAt}" Width="2*" />
                                <DataGridTextColumn Header="Module" Binding="{Binding ModuleName}" Width="1.5*" />
                                <DataGridTextColumn Header="Status" Binding="{Binding Status}" Width="*" />
                                <DataGridTextColumn Header="Duration" Binding="{Binding DurationMs}" Width="*" />
                                <DataGridTextColumn Header="Errors" Binding="{Binding FailedItems}" Width="*" />
                            </DataGrid.Columns>
                        </DataGrid>
                    </Grid>
                </Border>

                <Border Grid.Column="1" Classes="section">
                    <StackPanel Spacing="10">
                        <Grid ColumnDefinitions="*,Auto" ColumnSpacing="8">
                            <StackPanel Orientation="Horizontal" Spacing="6">
                                <Border Classes="badge">
                                    <TextBlock Text="{Binding SelectedRun.ModuleName, StringFormat='Module: {0}'}" FontSize="12" />
                                </Border>
                                <Border Classes="badge">
                                    <TextBlock Text="{Binding SelectedRun.Status, StringFormat='Status: {0}'}" FontSize="12" />
                                </Border>
                            </StackPanel>
                            <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="4">
                                <Button Classes="link" Content="Открыть папку" Command="{Binding OpenRunFolderCommand}" IsEnabled="{Binding SelectedRun, Converter={StaticResource NullToBoolConverter}}" />
                                <Button Classes="link" Content="Повторить" Command="{Binding RepeatRunCommand}" IsEnabled="{Binding SelectedRun, Converter={StaticResource NullToBoolConverter}}" />
                            </StackPanel>
                        </Grid>

                        <TextBlock Text="Детали прогона" Classes="section-title" />
                        <StackPanel Classes="empty-state"
                                    IsVisible="{Binding SelectedRun, Converter={StaticResource NullToBoolConverter}, ConverterParameter=invert}">
                            <TextBlock Text="Нет данных" Classes="empty-title" />
                            <TextBlock Text="Выполните запуск или выберите прогон" />
                        </StackPanel>

                        <Grid IsVisible="{Binding SelectedRun, Converter={StaticResource NullToBoolConverter}}"
                              ColumnDefinitions="150,*"
                              RowDefinitions="Auto,Auto,Auto,Auto,Auto"
                              RowSpacing="6"
                              ColumnSpacing="8">
                            <TextBlock Text="RunId" Classes="muted" />
                            <TextBlock Grid.Column="1" Text="{Binding SelectedRun.RunId}" TextWrapping="Wrap" />
                            <TextBlock Grid.Row="1" Text="Start" Classes="muted" />
                            <TextBlock Grid.Row="1" Grid.Column="1" Text="{Binding SelectedRun.StartedAt}" />
                            <TextBlock Grid.Row="2" Text="Duration" Classes="muted" />
                            <TextBlock Grid.Row="2" Grid.Column="1" Text="{Binding SelectedRun.DurationMs}" />
                            <TextBlock Grid.Row="3" Text="Target" Classes="muted" />
                            <TextBlock Grid.Row="3" Grid.Column="1" Text="{Binding SelectedRun.TestName}" TextWrapping="Wrap" />
                            <TextBlock Grid.Row="4" Text="Profile" Classes="muted" />
                            <TextBlock Grid.Row="4" Grid.Column="1" Text="{Binding SelectedRun.ModuleType}" />
                        </Grid>

                        <TextBlock Text="Артефакты" Classes="section-title" />
                        <Grid ColumnDefinitions="*,Auto" IsVisible="{Binding SelectedRun, Converter={StaticResource NullToBoolConverter}}">
                            <TextBlock Text="report.json" VerticalAlignment="Center" />
                            <Button Grid.Column="1" Content="Открыть" Command="{Binding OpenJsonCommand}" />
                        </Grid>
                        <Grid ColumnDefinitions="*,Auto" IsVisible="{Binding SelectedRun, Converter={StaticResource NullToBoolConverter}}">
                            <TextBlock Text="report.html" VerticalAlignment="Center" />
                            <Button Grid.Column="1" Content="Открыть" Command="{Binding OpenHtmlCommand}" />
                        </Grid>
                        <Grid ColumnDefinitions="*,Auto" IsVisible="{Binding SelectedRun, Converter={StaticResource NullToBoolConverter}}">
                            <TextBlock Text="Папка прогона" VerticalAlignment="Center" />
                            <Button Grid.Column="1" Content="Открыть" Command="{Binding OpenRunFolderCommand}" />
                        </Grid>

                        <Expander Header="Дополнительно" IsVisible="{Binding SelectedRun, Converter={StaticResource NullToBoolConverter}}">
                            <StackPanel Spacing="6" Margin="0,8,0,0">
                                <Button Content="Копировать RunId" Command="{Binding CopyRunIdCommand}" />
                                <Button Content="Копировать путь" Command="{Binding CopyRunPathCommand}" />
                                <Button Content="Удалить прогон" Command="{Binding RequestDeleteRunCommand}" />
                            </StackPanel>
                        </Expander>

                        <StackPanel IsVisible="{Binding IsDeleteConfirmVisible}" Spacing="8">
                            <TextBlock Text="{Binding UserMessage}" Foreground="OrangeRed" TextWrapping="Wrap" />
                            <StackPanel Orientation="Horizontal" Spacing="8">
                                <Button Content="Подтвердить удаление" Command="{Binding ConfirmDeleteRunCommand}" />
                                <Button Content="Отмена" Command="{Binding CancelDeleteRunCommand}" />
                            </StackPanel>
                        </StackPanel>

                        <TextBlock Text="{Binding UserMessage}" Classes="status-line" />
                    </StackPanel>
                </Border>
            </Grid>
        </Grid>
    </ScrollViewer>
</UserControl>
