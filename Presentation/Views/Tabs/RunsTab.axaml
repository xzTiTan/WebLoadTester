<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="clr-namespace:WebLoadTester.Presentation.ViewModels"
             x:Class="WebLoadTester.Presentation.Views.Tabs.RunsTab"
             x:DataType="vm:RunsTabViewModel">
    <Grid RowDefinitions="Auto,Auto,*" RowSpacing="{DynamicResource CardSpacing}">
        <Border Grid.Row="0" Classes="section">
            <StackPanel Spacing="{DynamicResource FieldSpacing}">
                <TextBlock Text="Фильтры" Classes="section-title" />
                <WrapPanel Classes="wrap-gap">
                    <StackPanel Spacing="4" MinWidth="260">
                        <TextBlock Text="Поиск" Classes="muted" />
                        <TextBox Watermark="Идентификатор запуска / moduleId / имя теста" Text="{Binding SearchText, Mode=TwoWay}" />
                    </StackPanel>
                    <StackPanel Spacing="4" MinWidth="220">
                        <TextBlock Text="Модуль" Classes="muted" />
                        <ComboBox ItemsSource="{Binding ModuleFilterOptions}" SelectedItem="{Binding SelectedModuleType, Mode=TwoWay}" />
                    </StackPanel>
                    <StackPanel Spacing="4" MinWidth="180">
                        <TextBlock Text="Статус" Classes="muted" />
                        <ComboBox ItemsSource="{Binding StatusFilterOptions}" SelectedItem="{Binding SelectedStatus, Mode=TwoWay}" />
                    </StackPanel>
                    <StackPanel Spacing="4" MinWidth="160">
                        <TextBlock Text="Период" Classes="muted" />
                        <ComboBox ItemsSource="{Binding PeriodOptions}" SelectedItem="{Binding SelectedPeriod, Mode=TwoWay}" />
                    </StackPanel>
                    <StackPanel Spacing="4" MinWidth="180">
                        <TextBlock Text="Ошибки" Classes="muted" />
                        <CheckBox Content="Только с ошибками" IsChecked="{Binding OnlyWithErrors, Mode=TwoWay}" />
                    </StackPanel>
                </WrapPanel>
            </StackPanel>
        </Border>

        <Border Grid.Row="1" Classes="section">
            <StackPanel Spacing="8">
                <WrapPanel Classes="wrap-gap">
                    <Button Content="Обновить" Classes="primary toolbar-button" Command="{Binding RefreshCommand}" />
                    <Button Content="Открыть папку" Classes="toolbar-button" Command="{Binding OpenRunFolderCommand}" IsEnabled="{Binding HasSelectedRun}" />
                    <Button Content="Открыть отчёт JSON" Classes="toolbar-button" Command="{Binding OpenJsonCommand}" IsEnabled="{Binding HasSelectedRun}" />
                    <Button Content="Открыть отчёт HTML" Classes="toolbar-button" Command="{Binding OpenHtmlCommand}" IsEnabled="{Binding HasSelectedRun}" />
                    <Button Content="Повторить запуск" Classes="toolbar-button" Command="{Binding RepeatRunCommand}" IsEnabled="{Binding CanRepeatRun}" />
                    <Button Content="Удалить" Classes="danger toolbar-button" Command="{Binding RequestDeleteRunCommand}" IsEnabled="{Binding HasSelectedRun}" />
                    <Button Content="Копировать идентификатор запуска" Classes="toolbar-button" Command="{Binding CopyRunIdCommand}" IsEnabled="{Binding HasSelectedRun}" />
                </WrapPanel>
                <TextBlock Text="{Binding RepeatRunHint}" IsVisible="{Binding HasRepeatRunHint}" />
            </StackPanel>
        </Border>

        <Grid Grid.Row="2" RowDefinitions="*,Auto,*" RowSpacing="8">
            <Border Grid.Row="0" Classes="section" Padding="0">
                <Grid>
                    <DataGrid x:Name="RunsGrid"
                              ItemsSource="{Binding Runs}"
                              SelectedItem="{Binding SelectedRun, Mode=TwoWay}"
                              AutoGenerateColumns="False"
                              IsVisible="{Binding HasRuns}">
                        <DataGrid.Columns>
                            <DataGridTextColumn Header="RunId" Binding="{Binding RunId}" Width="2*" />
                            <DataGridTextColumn Header="Started" Binding="{Binding StartedAt}" Width="2*" />
                            <DataGridTextColumn Header="FinalName" Binding="{Binding TestName}" Width="2*" />
                            <DataGridTextColumn Header="ModuleId" Binding="{Binding ModuleType}" Width="1.5*" />
                            <DataGridTextColumn Header="Status" Binding="{Binding Status}" Width="*" />
                            <DataGridTextColumn Header="Duration" Binding="{Binding DurationMs}" Width="*" />
                            <DataGridTextColumn Header="Errors" Binding="{Binding FailedItems}" Width="*" />
                        </DataGrid.Columns>
                    </DataGrid>
                    <TextBlock Text="Нет запусков" IsVisible="{Binding HasRuns, Converter={StaticResource BooleanNotConverter}}" Margin="8" />
                </Grid>
            </Border>

            <GridSplitter Grid.Row="1"
                          Height="6"
                          Background="{DynamicResource BorderBrushNeutral}"
                          HorizontalAlignment="Stretch"
                          ResizeDirection="Rows"
                          ResizeBehavior="PreviousAndNext" />

            <Border Grid.Row="2" Classes="section">
                <Expander Header="Детали" IsExpanded="True">
                    <StackPanel Margin="0,8,0,0" Spacing="10">
                        <WrapPanel Classes="wrap-gap" IsVisible="{Binding HasSelectedRun}">
                            <Border Classes="badge"><TextBlock Text="{Binding SelectedRun.ModuleType, StringFormat='Модуль: {0}'}" FontSize="12" /></Border>
                            <Border Classes="badge"><TextBlock Text="{Binding SelectedRun.Status, StringFormat='Статус: {0}'}" FontSize="12" /></Border>
                            <Border Classes="badge"><TextBlock Text="{Binding SelectedRun.RunId, StringFormat='Идентификатор: {0}'}" FontSize="12" /></Border>
                        </WrapPanel>

                        <StackPanel Classes="empty-state" IsVisible="{Binding HasSelectedRun, Converter={StaticResource BooleanNotConverter}}">
                            <TextBlock Text="Нет данных" Classes="empty-title" />
                            <TextBlock Text="Выполните запуск или выберите прогон" />
                        </StackPanel>

                        <StackPanel IsVisible="{Binding HasSelectedRun}" Spacing="6">
                            <TextBlock Text="{Binding DetailsSummary}" TextWrapping="Wrap" />
                            <TextBlock Text="{Binding DetailsProfile}" Classes="muted" TextWrapping="Wrap" />
                        </StackPanel>

                        <StackPanel IsVisible="{Binding HasSelectedRun}" Spacing="6">
                            <TextBlock Text="Артефакты" Classes="section-title" FontSize="16" />
                            <ItemsControl ItemsSource="{Binding ArtifactLinks}">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate x:DataType="vm:ArtifactLinkItem">
                                        <Grid ColumnDefinitions="*,Auto" ColumnSpacing="8" Margin="0,0,0,6">
                                            <TextBlock Text="{Binding Name}" TextWrapping="Wrap" />
                                            <Button Grid.Column="1" Content="Открыть" Command="{Binding $parent[ItemsControl].DataContext.OpenArtifactCommand}" CommandParameter="{Binding}" />
                                        </Grid>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </StackPanel>

                        <StackPanel IsVisible="{Binding HasSelectedRun}" Spacing="6">
                            <TextBlock Text="Топ ошибок" Classes="section-title" FontSize="16" />
                            <ItemsControl ItemsSource="{Binding TopErrors}">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate x:DataType="vm:TopErrorItem">
                                        <StackPanel Spacing="2" Margin="0,0,0,6">
                                            <TextBlock Text="{Binding Message, StringFormat='• {0}'}" TextWrapping="Wrap" />
                                            <TextBlock Text="{Binding Count, StringFormat='Количество: {0}'}" Classes="muted" Margin="18,0,0,0" />
                                        </StackPanel>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </StackPanel>

                        <StackPanel IsVisible="{Binding IsDeleteConfirmVisible}" Spacing="8">
                            <TextBlock Text="{Binding UserMessage}" Foreground="OrangeRed" TextWrapping="Wrap" />
                            <WrapPanel Classes="wrap-gap">
                                <Button Content="Подтвердить удаление" Command="{Binding ConfirmDeleteRunCommand}" />
                                <Button Content="Отмена" Command="{Binding CancelDeleteRunCommand}" />
                            </WrapPanel>
                        </StackPanel>

                        <TextBlock Text="{Binding UserMessage}" Classes="status-line" />
                    </StackPanel>
                </Expander>
            </Border>
        </Grid>
    </Grid>
</UserControl>
