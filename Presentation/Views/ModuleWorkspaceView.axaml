<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="clr-namespace:WebLoadTester.Presentation.ViewModels.Tabs"
             xmlns:root="clr-namespace:WebLoadTester.Presentation.ViewModels"
             xmlns:domain="clr-namespace:WebLoadTester.Core.Domain"
             xmlns:behaviors="clr-namespace:WebLoadTester.Presentation.Common.Behaviors"
             x:Class="WebLoadTester.Presentation.Views.ModuleWorkspaceView"
             x:Name="Root"
             x:DataType="vm:ModuleFamilyViewModel">
    <Grid ColumnDefinitions="240,*" ColumnSpacing="16">
        <Border Classes="section">
            <StackPanel Spacing="8">
                <TextBlock Text="Модули" Classes="section-title" />
                <ListBox ItemsSource="{Binding Modules}"
                         SelectedItem="{Binding SelectedModule, Mode=TwoWay}"
                         MinHeight="240">
                    <ListBox.ItemTemplate>
                        <DataTemplate x:DataType="root:ModuleItemViewModel">
                            <TextBlock Text="{Binding DisplayName}" />
                        </DataTemplate>
                    </ListBox.ItemTemplate>
                </ListBox>
            </StackPanel>
        </Border>

        <DockPanel Grid.Column="1">
            <Border Classes="app-bar" DockPanel.Dock="Top">
                <Grid ColumnDefinitions="*,Auto" ColumnSpacing="16">
                    <StackPanel Spacing="4">
                        <TextBlock Text="{Binding SelectedModule.DisplayName}" Classes="section-title" />
                        <TextBlock Text="{Binding SelectedModule.Description}" Classes="status-line" />
                    </StackPanel>
                    <StackPanel Grid.Column="1" Spacing="6" HorizontalAlignment="Right">
                        <Border x:Name="Vm"
                                IsVisible="False"
                                Width="0"
                                Height="0"
                                DataContext="{Binding DataContext, RelativeSource={RelativeSource AncestorType=Window}}"
                                x:DataType="root:MainWindowViewModel" />
                        <WrapPanel Classes="toolbar-wrap" HorizontalAlignment="Right">
                            <Button Content="Старт" Margin="0,0,8,8" Classes="primary"
                                    Command="{Binding StartCommand, ElementName=Vm}" />
                            <Button Content="Перезапуск" Margin="0,0,8,8"
                                    Command="{Binding RestartCommand, ElementName=Vm}" />
                            <Button Content="Остановить" Margin="0,0,8,8"
                                    Command="{Binding StopCommand, ElementName=Vm}" />
                            <Button Content="Отмена" Margin="0,0,8,8" Classes="danger"
                                    Command="{Binding CancelCommand, ElementName=Vm}" />
                        </WrapPanel>
                        <ProgressBar Minimum="0" Maximum="100"
                                     Value="{Binding ProgressPercent, ElementName=Vm}"
                                     IsIndeterminate="{Binding IsProgressIndeterminate, ElementName=Vm}" />
                        <StackPanel Spacing="2" HorizontalAlignment="Right">
                            <TextBlock Text="{Binding RunStage, ElementName=Vm}" Classes="muted" />
                            <TextBlock Text="{Binding ProgressText, ElementName=Vm}" Classes="status-line" />
                        </StackPanel>
                    </StackPanel>
                </Grid>
            </Border>

            <ScrollViewer VerticalScrollBarVisibility="Auto">
                <StackPanel Spacing="16" MaxWidth="1200" HorizontalAlignment="Center">
                    <Border Classes="section">
                        <StackPanel Spacing="8">
                            <Grid ColumnDefinitions="*,Auto">
                                <TextBlock Text="Тесты (Test Library)" Classes="section-title" />
                                <WrapPanel Grid.Column="1" Classes="toolbar-wrap">
                                    <Button Content="Обновить" Margin="0,0,8,8"
                                            Command="{Binding SelectedModule.TestLibrary.RefreshCommand}" />
                                    <Button Content="Загрузить" Margin="0,0,8,8"
                                            Command="{Binding SelectedModule.TestLibrary.LoadSelectedCommand}" />
                                    <Button Content="Сохранить" Margin="0,0,8,8"
                                            Command="{Binding SelectedModule.TestLibrary.SaveCurrentCommand}" />
                                    <Button Content="Сохранить как" Margin="0,0,8,8"
                                            Classes="ghost"
                                            Command="{Binding SelectedModule.TestLibrary.SaveAsCommand}" />
                                    <Button Content="Удалить" Margin="0,0,8,8"
                                            Classes="danger"
                                            Command="{Binding SelectedModule.TestLibrary.RequestDeleteSelectedCommand}" />
                                </WrapPanel>
                            </Grid>
                            <Grid ColumnDefinitions="{StaticResource FieldRowColumns}" Classes="field-row">
                                <TextBlock Text="Тест" Classes="field-label" />
                                <ComboBox Classes="field-control"
                                          ItemsSource="{Binding SelectedModule.TestLibrary.TestCases}"
                                          SelectedItem="{Binding SelectedModule.TestLibrary.SelectedTestCase, Mode=TwoWay}" />
                            </Grid>
                            <StackPanel IsVisible="{Binding SelectedModule.TestLibrary.IsDeleteConfirmVisible}" Spacing="8">
                                <TextBlock Text="{Binding SelectedModule.TestLibrary.StatusMessage}" Foreground="OrangeRed" TextWrapping="Wrap" />
                                <WrapPanel Classes="toolbar-wrap">
                                    <Button Content="Подтвердить удаление" Margin="0,0,8,8"
                                            Command="{Binding SelectedModule.TestLibrary.ConfirmDeleteSelectedCommand}" />
                                    <Button Content="Отмена" Margin="0,0,8,8"
                                            Classes="ghost"
                                            Command="{Binding SelectedModule.TestLibrary.CancelDeleteSelectedCommand}" />
                                </WrapPanel>
                            </StackPanel>
                            <Grid ColumnDefinitions="{StaticResource FieldRowColumns}" Classes="field-row">
                                <TextBlock Text="Название теста" Classes="field-label" />
                                <TextBox Classes="field-control" Text="{Binding SelectedModule.TestLibrary.TestName, Mode=TwoWay}" />
                            </Grid>
                            <Grid ColumnDefinitions="{StaticResource FieldRowColumns}" Classes="field-row">
                                <TextBlock Text="Описание" Classes="field-label" />
                                <TextBox Classes="field-control" Text="{Binding SelectedModule.TestLibrary.TestDescription, Mode=TwoWay}" />
                            </Grid>
                            <Grid ColumnDefinitions="{StaticResource FieldRowColumns}" Classes="field-row">
                                <TextBlock Text="Комментарий к версии" Classes="field-label" />
                                <TextBox Classes="field-control" Text="{Binding SelectedModule.TestLibrary.ChangeNote, Mode=TwoWay}" />
                            </Grid>
                            <TextBlock Text="{Binding SelectedModule.TestLibrary.StatusMessage}" Classes="status-line" />
                        </StackPanel>
                    </Border>

                    <ContentControl Content="{Binding SelectedModule.SettingsViewModel}" />

                    <Border Classes="section">
                        <StackPanel Spacing="8"
                                    DataContext="{Binding DataContext, RelativeSource={RelativeSource AncestorType=Window}}"
                                    x:DataType="root:MainWindowViewModel">
                            <StackPanel Spacing="8"
                                        DataContext="{Binding RunProfile}"
                                        x:DataType="root:RunProfileViewModel">
                                <Grid ColumnDefinitions="*,Auto">
                                    <TextBlock Text="Профиль запуска" Classes="section-title" />
                                    <WrapPanel Grid.Column="1" Classes="toolbar-wrap">
                                        <Button Content="Обновить" Margin="0,0,8,8" Command="{Binding RefreshCommand}" />
                                        <Button Content="Сохранить профиль" Margin="0,0,8,8"
                                                Command="{Binding SaveProfileCommand}" />
                                        <Button Content="Сохранить как" Margin="0,0,8,8"
                                                Classes="ghost"
                                                Command="{Binding SaveAsProfileCommand}" />
                                        <Button Content="Удалить" Margin="0,0,8,8"
                                                Classes="danger"
                                                Command="{Binding RequestDeleteProfileCommand}" />
                                    </WrapPanel>
                                </Grid>
                                <Grid ColumnDefinitions="{StaticResource FieldRowColumns}" Classes="field-row">
                                    <TextBlock Text="Профиль" Classes="field-label" />
                                    <ComboBox Classes="field-control"
                                              ItemsSource="{Binding Profiles}"
                                              SelectedItem="{Binding SelectedProfile, Mode=TwoWay}">
                                        <ComboBox.ItemTemplate>
                                            <DataTemplate x:DataType="domain:RunProfile">
                                                <TextBlock Text="{Binding Name}" />
                                            </DataTemplate>
                                        </ComboBox.ItemTemplate>
                                    </ComboBox>
                                </Grid>
                                <StackPanel IsVisible="{Binding IsDeleteConfirmVisible}" Spacing="8">
                                    <TextBlock Text="{Binding StatusMessage}" Foreground="OrangeRed" TextWrapping="Wrap" />
                                    <WrapPanel Classes="toolbar-wrap">
                                        <Button Content="Подтвердить удаление" Margin="0,0,8,8"
                                                Command="{Binding ConfirmDeleteProfileCommand}" />
                                        <Button Content="Отмена" Margin="0,0,8,8"
                                                Classes="ghost"
                                                Command="{Binding CancelDeleteProfileCommand}" />
                                    </WrapPanel>
                                </StackPanel>
                                <Grid ColumnDefinitions="{StaticResource FieldRowColumns}" Classes="field-row">
                                    <TextBlock Text="Название профиля" Classes="field-label" />
                                    <TextBox Classes="field-control" Text="{Binding ProfileName, Mode=TwoWay}" />
                                </Grid>
                                <Grid ColumnDefinitions="{StaticResource FieldRowColumns}" Classes="field-row">
                                    <TextBlock Text="Параллельность" Classes="field-label" />
                                    <NumericUpDown Classes="field-control" Minimum="1" Value="{Binding Parallelism, Mode=TwoWay}" />
                                </Grid>
                                <Grid ColumnDefinitions="{StaticResource FieldRowColumns}" Classes="field-row">
                                    <TextBlock Text="Режим" Classes="field-label" />
                                    <ComboBox Classes="field-control"
                                              ItemsSource="{Binding ModeOptions}"
                                              SelectedItem="{Binding Mode, Mode=TwoWay}" />
                                </Grid>
                                <Grid ColumnDefinitions="{StaticResource FieldRowColumns}" Classes="field-row" IsVisible="{Binding IsIterationsMode}">
                                    <TextBlock Text="Итерации" Classes="field-label" />
                                    <NumericUpDown Classes="field-control" Minimum="1" Value="{Binding Iterations, Mode=TwoWay}" />
                                </Grid>
                                <Grid ColumnDefinitions="{StaticResource FieldRowColumns}" Classes="field-row" IsVisible="{Binding IsDurationMode}">
                                    <TextBlock Text="Длительность (сек)" Classes="field-label" />
                                    <NumericUpDown Classes="field-control" Minimum="10" Value="{Binding DurationSeconds, Mode=TwoWay}" />
                                </Grid>
                                <Grid ColumnDefinitions="{StaticResource FieldRowColumns}" Classes="field-row">
                                    <TextBlock Text="Таймаут (сек)" Classes="field-label" />
                                    <NumericUpDown Classes="field-control" Minimum="5" Value="{Binding TimeoutSeconds, Mode=TwoWay}" />
                                </Grid>
                                <Grid ColumnDefinitions="{StaticResource FieldRowColumns}" Classes="field-row">
                                    <TextBlock Text="Headless" Classes="field-label" />
                                    <CheckBox Classes="field-control" Content="Включено" IsChecked="{Binding Headless, Mode=TwoWay}" />
                                </Grid>
                                <Grid ColumnDefinitions="{StaticResource FieldRowColumns}" Classes="field-row">
                                    <TextBlock Text="Скриншоты" Classes="field-label" />
                                    <ComboBox Classes="field-control"
                                              ItemsSource="{Binding ScreenshotsPolicyOptions}"
                                              SelectedItem="{Binding ScreenshotsPolicy, Mode=TwoWay}" />
                                </Grid>
                                <Grid ColumnDefinitions="{StaticResource FieldRowColumns}" Classes="field-row">
                                    <TextBlock Text="HTML-отчёт" Classes="field-label" />
                                    <CheckBox Classes="field-control" Content="Включено" IsChecked="{Binding HtmlReportEnabled, Mode=TwoWay}" />
                                </Grid>
                                <Grid ColumnDefinitions="{StaticResource FieldRowColumns}" Classes="field-row">
                                    <TextBlock Text="Telegram" Classes="field-label" />
                                    <CheckBox Classes="field-control" Content="Отправлять статус" IsChecked="{Binding TelegramEnabled, Mode=TwoWay}" />
                                </Grid>
                                <Grid ColumnDefinitions="{StaticResource FieldRowColumns}" Classes="field-row">
                                    <TextBlock Text="Preflight" Classes="field-label" />
                                    <CheckBox Classes="field-control" Content="Включено" IsChecked="{Binding PreflightEnabled, Mode=TwoWay}" />
                                </Grid>
                                <Border Classes="warning-panel" IsVisible="{Binding HasWarning}">
                                    <TextBlock Text="{Binding WarningMessage}" />
                                </Border>
                                <TextBlock Text="{Binding StatusMessage}" Classes="status-line" />
                            </StackPanel>
                        </StackPanel>
                    </Border>

                    <Border Classes="section">
                        <StackPanel Spacing="8">
                            <TextBlock Text="Итоговая сводка" Classes="section-title" />
                            <StackPanel Classes="empty-state"
                                        IsVisible="{Binding DataContext.SelectedModule.HasReport, ElementName=Root, Converter={StaticResource BooleanNotConverter}}">
                                <TextBlock Text="Нет данных" Classes="empty-title" />
                                <TextBlock Text="Выберите прогон или выполните запуск" />
                            </StackPanel>
                            <ContentControl Content="{Binding SelectedModule.LastReport}"
                                            IsVisible="{Binding SelectedModule.HasReport}">
                                <ContentControl.ContentTemplate>
                                    <DataTemplate x:DataType="domain:TestReport">
                                        <Grid ColumnDefinitions="Auto,*" RowDefinitions="Auto,Auto,Auto,Auto,Auto" ColumnSpacing="12" RowSpacing="6">
                                            <TextBlock Text="Статус" Classes="muted" />
                                            <TextBlock Grid.Column="1" Text="{Binding Status}" />
                                            <TextBlock Grid.Row="1" Text="Длительность" Classes="muted" />
                                            <TextBlock Grid.Row="1" Grid.Column="1" Text="{Binding Metrics.TotalDurationMs, StringFormat='{}{0:F0} мс'}" />
                                            <TextBlock Grid.Row="2" Text="Ошибки" Classes="muted" />
                                            <TextBlock Grid.Row="2" Grid.Column="1" Text="{Binding Metrics.FailedItems}" />
                                            <TextBlock Grid.Row="3" Text="Среднее" Classes="muted" />
                                            <TextBlock Grid.Row="3" Grid.Column="1" Text="{Binding Metrics.AverageMs, StringFormat='{}{0:F1} мс'}" />
                                            <TextBlock Grid.Row="4" Text="P95" Classes="muted" />
                                            <TextBlock Grid.Row="4" Grid.Column="1" Text="{Binding Metrics.P95Ms, StringFormat='{}{0:F1} мс'}" />
                                        </Grid>
                                    </DataTemplate>
                                </ContentControl.ContentTemplate>
                            </ContentControl>
                        </StackPanel>
                    </Border>

                    <Border Classes="section">
                        <StackPanel Spacing="8">
                            <TextBlock Text="Детальные результаты" Classes="section-title" />
                            <StackPanel Classes="empty-state"
                                        IsVisible="{Binding DataContext.SelectedModule.HasReport, ElementName=Root, Converter={StaticResource BooleanNotConverter}}">
                                <TextBlock Text="Нет данных" Classes="empty-title" />
                                <TextBlock Text="Выберите прогон или выполните запуск" />
                            </StackPanel>
                            <DataGrid ItemsSource="{Binding SelectedModule.DisplayResults}"
                                      Classes="list-min-180"
                                      IsVisible="{Binding SelectedModule.HasReport}">
                                <DataGrid.Columns>
                                    <DataGridTextColumn Header="Тип" Binding="{Binding Kind}" Width="140" />
                                    <DataGridTemplateColumn Header="Название" Width="2*">
                                        <DataGridTemplateColumn.CellTemplate>
                                            <DataTemplate x:DataType="domain:ResultBase">
                                                <TextBlock Text="{Binding ., Converter={StaticResource ResultDisplayNameConverter}}" />
                                            </DataTemplate>
                                        </DataGridTemplateColumn.CellTemplate>
                                    </DataGridTemplateColumn>
                                    <DataGridTextColumn Header="Успех" Binding="{Binding Success}" Width="120" />
                                    <DataGridTextColumn Header="Длительность, мс" Binding="{Binding DurationMs}" Width="160" />
                                    <DataGridTextColumn Header="Ошибка" Binding="{Binding ErrorMessage}" Width="2*" />
                                </DataGrid.Columns>
                            </DataGrid>
                        </StackPanel>
                    </Border>

                    <Border Classes="section">
                        <StackPanel Spacing="8"
                                    x:Name="ArtifactsPanel"
                                    DataContext="{Binding DataContext, RelativeSource={RelativeSource AncestorType=Window}}"
                                    x:DataType="root:MainWindowViewModel">
                            <Grid ColumnDefinitions="*,Auto">
                                <TextBlock Text="Артефакты" Classes="section-title" />
                                <WrapPanel Grid.Column="1" Classes="toolbar-wrap">
                                    <Button Content="Открыть JSON" Margin="0,0,8,8" Command="{Binding OpenLatestJsonCommand}" />
                                    <Button Content="Открыть HTML" Margin="0,0,8,8" Command="{Binding OpenLatestHtmlCommand}" />
                                    <Button Content="Открыть папку прогона" Margin="0,0,8,8" Command="{Binding OpenLatestRunFolderCommand}" />
                                </WrapPanel>
                            </Grid>
                            <StackPanel Classes="empty-state"
                                        IsVisible="{Binding DataContext.SelectedModule.HasReport, ElementName=Root, Converter={StaticResource BooleanNotConverter}}">
                                <TextBlock Text="Нет данных" Classes="empty-title" />
                                <TextBlock Text="Выполните запуск, чтобы получить артефакты" />
                            </StackPanel>
                            <ItemsControl ItemsSource="{Binding DataContext.SelectedModule.ArtifactItems, ElementName=Root}"
                                          IsVisible="{Binding DataContext.SelectedModule.HasReport, ElementName=Root}">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate x:DataType="root:ArtifactListItem">
                                        <Grid ColumnDefinitions="*,Auto" ColumnSpacing="8">
                                            <TextBlock Text="{Binding Name}" TextWrapping="Wrap" />
                                            <Button Grid.Column="1" Content="Открыть"
                                                    Command="{Binding DataContext.OpenArtifactCommand, ElementName=ArtifactsPanel}"
                                                    CommandParameter="{Binding}" />
                                        </Grid>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </StackPanel>
                    </Border>

                    <Border Classes="section">
                        <StackPanel Spacing="8"
                                    DataContext="{Binding DataContext, RelativeSource={RelativeSource AncestorType=Window}}"
                                    x:DataType="root:MainWindowViewModel">
                            <Expander Header="Лог выполнения" IsExpanded="True">
                                <Border Classes="log-box" MinHeight="160" MaxHeight="260">
                                    <StackPanel Spacing="8">
                                        <CheckBox Content="Только ошибки" IsChecked="{Binding LogOnlyErrors, Mode=TwoWay}" />
                                        <ListBox ItemsSource="{Binding FilteredLogEntries}"
                                             Classes="loglist"
                                             behaviors:AutoScrollBehavior.IsEnabled="True">
                                            <ListBox.ItemTemplate>
                                                <DataTemplate>
                                                    <TextBlock Classes="logline" Text="{Binding}" />
                                                </DataTemplate>
                                            </ListBox.ItemTemplate>
                                        </ListBox>
                                    </StackPanel>
                                </Border>
                            </Expander>
                        </StackPanel>
                    </Border>
                </StackPanel>
            </ScrollViewer>
        </DockPanel>
    </Grid>
</UserControl>
