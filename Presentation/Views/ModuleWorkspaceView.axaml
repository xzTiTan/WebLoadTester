<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="clr-namespace:WebLoadTester.Presentation.ViewModels.Tabs"
             xmlns:root="clr-namespace:WebLoadTester.Presentation.ViewModels"
             xmlns:domain="clr-namespace:WebLoadTester.Core.Domain"
             x:Class="WebLoadTester.Presentation.Views.ModuleWorkspaceView"
             x:Name="Root"
             x:DataType="vm:ModuleFamilyViewModel">
    <Grid RowDefinitions="Auto,Auto,Auto,*" RowSpacing="12">
        <ContentControl x:Name="VmProxy"
                        Width="0"
                        Height="0"
                        IsVisible="False"
                        DataContext="{Binding DataContext, RelativeSource={RelativeSource AncestorType=Window}}" />

        <!-- Row 1: Run controls -->
        <Border Grid.Row="0" Classes="app-bar">
            <Grid ColumnDefinitions="*,Auto" ColumnSpacing="16">
                <StackPanel Spacing="6">
                    <StackPanel Spacing="2"
                                DataContext="{Binding DataContext, ElementName=VmProxy}"
                                x:DataType="root:MainWindowViewModel">
                        <ProgressBar Minimum="0" Maximum="100"
                                     Value="{Binding ProgressPercent}"
                                     IsIndeterminate="{Binding IsProgressIndeterminate}" />
                        <Grid ColumnDefinitions="Auto,*" ColumnSpacing="12">
                            <TextBlock Text="{Binding RunStage}" Classes="muted" />
                            <TextBlock Grid.Column="1" Text="{Binding ProgressText}" Classes="status-line" />
                        </Grid>
                        <TextBlock Text="Нажмите Старт для запуска. report.json создаётся всегда; report.html — по флагу."
                                   IsVisible="{Binding ShowRunHint}"
                                   TextWrapping="Wrap" />
                    </StackPanel>
                </StackPanel>
                <StackPanel Grid.Column="1"
                            Spacing="6"
                            HorizontalAlignment="Right"
                            DataContext="{Binding DataContext, ElementName=VmProxy}"
                            x:DataType="root:MainWindowViewModel">
                    <WrapPanel Classes="toolbar-wrap" HorizontalAlignment="Right">
                        <Button Content="Старт" Margin="0,0,8,8" Classes="primary"
                                Command="{Binding StartCommand}" />
                        <Button Content="Перезапуск" Margin="0,0,8,8"
                                Command="{Binding RestartCommand}" />
                        <Button Content="Остановить" Margin="0,0,8,8"
                                Command="{Binding StopCommand}" />
                        <Button Content="Отмена" Margin="0,0,8,8" Classes="danger"
                                Command="{Binding CancelCommand}" />
                    </WrapPanel>
                </StackPanel>
            </Grid>
        </Border>

        <!-- Row 2: Module selection -->
        <Border Grid.Row="1" Classes="app-bar">
            <ListBox ItemsSource="{Binding Modules}"
                     SelectedItem="{Binding SelectedModule, Mode=TwoWay}"
                     Classes="segmented-bar"
                     BorderThickness="0">
                <ListBox.ItemsPanel>
                    <ItemsPanelTemplate>
                        <StackPanel Orientation="Horizontal" Spacing="8" />
                    </ItemsPanelTemplate>
                </ListBox.ItemsPanel>
                <ListBox.ItemTemplate>
                    <DataTemplate x:DataType="root:ModuleItemViewModel">
                        <TextBlock Text="{Binding DisplayName}" />
                    </DataTemplate>
                </ListBox.ItemTemplate>
            </ListBox>
        </Border>

        <!-- Row 3: Module info -->
        <Border Grid.Row="2" Classes="app-bar">
            <Grid ColumnDefinitions="200,*" ColumnSpacing="16">
                <TextBlock Text="{Binding SelectedModule.DisplayName}" Classes="section-title" />
                <TextBlock Grid.Column="1"
                           Text="{Binding SelectedModule.Description}"
                           Classes="status-line"
                           TextWrapping="Wrap" />
            </Grid>
        </Border>

        <!-- Body -->
        <ScrollViewer Grid.Row="3" VerticalScrollBarVisibility="Auto">
            <StackPanel Spacing="16" MaxWidth="1200" HorizontalAlignment="Center">
                <Border Classes="section">
                    <StackPanel Spacing="8"
                                DataContext="{Binding SelectedModule.ModuleConfig}"
                                x:DataType="root:ModuleConfigViewModel">
                        <Grid ColumnDefinitions="*,Auto">
                            <TextBlock Text="Конфигурация" Classes="section-title" />
                            <WrapPanel Grid.Column="1" Classes="toolbar-wrap">
                                <Button Content="Обновить" Margin="0,0,8,8"
                                        Command="{Binding RefreshCommand}" />
                                <Button Content="Загрузить" Margin="0,0,8,8"
                                        Command="{Binding LoadSelectedCommand}" />
                                <Button Content="Сохранить" Margin="0,0,8,8"
                                        Command="{Binding SaveNewCommand}" />
                                <Button Content="Перезаписать" Margin="0,0,8,8"
                                        Classes="ghost"
                                        Command="{Binding SaveOverwriteCommand}" />
                                <Button Content="Удалить" Margin="0,0,8,8"
                                        Classes="danger"
                                        Command="{Binding RequestDeleteSelectedCommand}" />
                            </WrapPanel>
                        </Grid>
                        <Grid ColumnDefinitions="{StaticResource FieldRowColumns}" Classes="field-row">
                            <TextBlock Text="Конфигурация" Classes="field-label" />
                            <ComboBox Classes="field-control"
                                      ItemsSource="{Binding Configs}"
                                      SelectedItem="{Binding SelectedConfig, Mode=TwoWay}">
                                <ComboBox.ItemTemplate>
                                    <DataTemplate x:DataType="domain:ModuleConfigSummary">
                                        <TextBlock Text="{Binding FinalName}" />
                                    </DataTemplate>
                                </ComboBox.ItemTemplate>
                            </ComboBox>
                        </Grid>
                        <StackPanel IsVisible="{Binding IsDeleteConfirmVisible}" Spacing="8">
                            <TextBlock Text="{Binding StatusMessage}" Foreground="OrangeRed" TextWrapping="Wrap" />
                            <WrapPanel Classes="toolbar-wrap">
                                <Button Content="Подтвердить удаление" Margin="0,0,8,8"
                                        Command="{Binding ConfirmDeleteSelectedCommand}" />
                                <Button Content="Отмена" Margin="0,0,8,8"
                                        Classes="ghost"
                                        Command="{Binding CancelDeleteSelectedCommand}" />
                            </WrapPanel>
                        </StackPanel>
                        <Grid ColumnDefinitions="{StaticResource FieldRowColumns}" Classes="field-row">
                            <TextBlock Text="Имя (без пробелов)" Classes="field-label" />
                            <TextBox Classes="field-control"
                                     Watermark="Например: DemoConfig"
                                     Text="{Binding UserName, Mode=TwoWay}" />
                        </Grid>
                        <Grid ColumnDefinitions="{StaticResource FieldRowColumns}" Classes="field-row">
                            <TextBlock Text="Финальное имя" Classes="field-label" />
                            <TextBlock Classes="field-control" Text="{Binding FinalNamePreview}" />
                        </Grid>
                        <Grid ColumnDefinitions="{StaticResource FieldRowColumns}" Classes="field-row">
                            <TextBlock Text="Описание" Classes="field-label" />
                            <TextBox Classes="field-control"
                                     Watermark="Опишите назначение конфигурации"
                                     Text="{Binding Description, Mode=TwoWay}" />
                        </Grid>
                        <TextBlock Text="{Binding StatusMessage}" Classes="status-line" />
                    </StackPanel>
                </Border>

                <Border Classes="section">
                    <StackPanel Spacing="8"
                                DataContext="{Binding DataContext, ElementName=VmProxy}"
                                x:DataType="root:MainWindowViewModel">
                        <StackPanel Spacing="8"
                                    DataContext="{Binding RunProfile}"
                                    x:DataType="root:RunProfileViewModel">
                            <TextBlock Text="Параметры запуска" Classes="section-title" />
                            <Grid ColumnDefinitions="{StaticResource FieldRowColumns}" Classes="field-row">
                                <TextBlock Text="Параллельность" Classes="field-label" />
                                <NumericUpDown Classes="field-control" Minimum="1" Value="{Binding Parallelism, Mode=TwoWay}" />
                            </Grid>
                            <Grid ColumnDefinitions="{StaticResource FieldRowColumns}" Classes="field-row">
                                <TextBlock Text="Режим" Classes="field-label" />
                                <ComboBox Classes="field-control"
                                          ItemsSource="{Binding ModeOptions}"
                                          SelectedItem="{Binding Mode, Mode=TwoWay}" />
                            </Grid>
                            <Grid ColumnDefinitions="{StaticResource FieldRowColumns}" Classes="field-row" IsVisible="{Binding IsIterationsMode}">
                                <TextBlock Text="Итерации" Classes="field-label" />
                                <NumericUpDown Classes="field-control" Minimum="1" Value="{Binding Iterations, Mode=TwoWay}" />
                            </Grid>
                            <Grid ColumnDefinitions="{StaticResource FieldRowColumns}" Classes="field-row" IsVisible="{Binding IsDurationMode}">
                                <TextBlock Text="Длительность (сек)" Classes="field-label" />
                                <NumericUpDown Classes="field-control" Minimum="10" Value="{Binding DurationSeconds, Mode=TwoWay}" />
                            </Grid>
                            <Grid ColumnDefinitions="{StaticResource FieldRowColumns}" Classes="field-row">
                                <TextBlock Text="Таймаут (сек)" Classes="field-label" />
                                <NumericUpDown Classes="field-control" Minimum="5" Value="{Binding TimeoutSeconds, Mode=TwoWay}" />
                            </Grid>
                            <Grid ColumnDefinitions="{StaticResource FieldRowColumns}" Classes="field-row">
                                <TextBlock Text="HTML-отчёт" Classes="field-label" />
                                <CheckBox Classes="field-control" Content="Включено" IsChecked="{Binding HtmlReportEnabled, Mode=TwoWay}" />
                            </Grid>
                            <Grid ColumnDefinitions="{StaticResource FieldRowColumns}" Classes="field-row">
                                <TextBlock Text="Telegram" Classes="field-label" />
                                <CheckBox Classes="field-control" Content="Отправлять статус" IsChecked="{Binding TelegramEnabled, Mode=TwoWay}" />
                            </Grid>
                            <Grid ColumnDefinitions="{StaticResource FieldRowColumns}" Classes="field-row">
                                <TextBlock Text="Preflight" Classes="field-label" />
                                <CheckBox Classes="field-control" Content="Включено" IsChecked="{Binding PreflightEnabled, Mode=TwoWay}" />
                            </Grid>
                            <Border Classes="warning-panel" IsVisible="{Binding HasWarning}">
                                <TextBlock Text="{Binding WarningMessage}" />
                            </Border>
                            <TextBlock Text="{Binding StatusMessage}" Classes="status-line" />
                        </StackPanel>
                    </StackPanel>
                </Border>

                <Border Classes="section">
                    <StackPanel Spacing="8">
                        <TextBlock Text="Настройки модуля" Classes="section-title" />
                        <ContentControl Content="{Binding SelectedModule.SettingsViewModel}" />
                    </StackPanel>
                </Border>

                <Border Classes="section">
                    <StackPanel Spacing="12">
                        <TextBlock Text="Результаты" Classes="section-title" />
                        <StackPanel Classes="empty-state"
                                    IsVisible="{Binding DataContext.SelectedModule.HasReport, ElementName=Root, Converter={StaticResource BooleanNotConverter}}">
                            <TextBlock Text="Нет данных" Classes="empty-title" />
                            <TextBlock Text="Выберите прогон или выполните запуск" />
                        </StackPanel>

                        <ContentControl Content="{Binding SelectedModule.LastReport}"
                                        IsVisible="{Binding SelectedModule.HasReport}">
                            <ContentControl.ContentTemplate>
                                <DataTemplate x:DataType="domain:TestReport">
                                    <Grid ColumnDefinitions="Auto,*" RowDefinitions="Auto,Auto,Auto,Auto,Auto" ColumnSpacing="12" RowSpacing="6">
                                        <TextBlock Text="Статус" Classes="muted" />
                                        <TextBlock Grid.Column="1" Text="{Binding Status}" />
                                        <TextBlock Grid.Row="1" Text="Длительность" Classes="muted" />
                                        <TextBlock Grid.Row="1" Grid.Column="1" Text="{Binding Metrics.TotalDurationMs, StringFormat='{}{0:F0} мс'}" />
                                        <TextBlock Grid.Row="2" Text="Ошибки" Classes="muted" />
                                        <TextBlock Grid.Row="2" Grid.Column="1" Text="{Binding Metrics.FailedItems}" />
                                        <TextBlock Grid.Row="3" Text="Среднее" Classes="muted" />
                                        <TextBlock Grid.Row="3" Grid.Column="1" Text="{Binding Metrics.AverageMs, StringFormat='{}{0:F1} мс'}" />
                                        <TextBlock Grid.Row="4" Text="P95" Classes="muted" />
                                        <TextBlock Grid.Row="4" Grid.Column="1" Text="{Binding Metrics.P95Ms, StringFormat='{}{0:F1} мс'}" />
                                    </Grid>
                                </DataTemplate>
                            </ContentControl.ContentTemplate>
                        </ContentControl>

                        <DataGrid ItemsSource="{Binding SelectedModule.DisplayResults}"
                                  Classes="list-min-180"
                                  MaxHeight="360"
                                  IsVisible="{Binding SelectedModule.HasReport}">
                            <DataGrid.Columns>
                                <DataGridTextColumn Header="Тип" Binding="{Binding Kind}" Width="140" />
                                <DataGridTemplateColumn Header="Название" Width="2*">
                                    <DataGridTemplateColumn.CellTemplate>
                                        <DataTemplate x:DataType="domain:ResultBase">
                                            <TextBlock Text="{Binding ., Converter={StaticResource ResultDisplayNameConverter}}" />
                                        </DataTemplate>
                                    </DataGridTemplateColumn.CellTemplate>
                                </DataGridTemplateColumn>
                                <DataGridTextColumn Header="Успех" Binding="{Binding Success}" Width="120" />
                                <DataGridTextColumn Header="Длительность, мс" Binding="{Binding DurationMs}" Width="160" />
                                <DataGridTextColumn Header="Ошибка" Binding="{Binding ErrorMessage}" Width="2*" />
                            </DataGrid.Columns>
                        </DataGrid>

                        <StackPanel Spacing="8"
                                    x:Name="ArtifactsPanel"
                                    DataContext="{Binding DataContext, ElementName=VmProxy}"
                                    x:DataType="root:MainWindowViewModel">
                            <Grid ColumnDefinitions="*,Auto">
                                <TextBlock Text="Артефакты" Classes="section-title" />
                                <WrapPanel Grid.Column="1" Classes="toolbar-wrap">
                                    <Button Content="Открыть JSON" Margin="0,0,8,8" Command="{Binding OpenLatestJsonCommand}" />
                                    <Button Content="Открыть HTML" Margin="0,0,8,8" Command="{Binding OpenLatestHtmlCommand}" />
                                    <Button Content="Открыть папку прогона" Margin="0,0,8,8" Command="{Binding OpenLatestRunFolderCommand}" />
                                </WrapPanel>
                            </Grid>
                            <StackPanel Classes="empty-state"
                                        IsVisible="{Binding DataContext.SelectedModule.HasReport, ElementName=Root, Converter={StaticResource BooleanNotConverter}}">
                                <TextBlock Text="Нет данных" Classes="empty-title" />
                                <TextBlock Text="Выполните запуск, чтобы получить артефакты" />
                            </StackPanel>
                            <ScrollViewer MaxHeight="260"
                                          VerticalScrollBarVisibility="Auto"
                                          IsVisible="{Binding DataContext.SelectedModule.HasReport, ElementName=Root}">
                                <ItemsControl ItemsSource="{Binding DataContext.SelectedModule.ArtifactItems, ElementName=Root}">
                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate x:DataType="root:ArtifactListItem">
                                            <Grid ColumnDefinitions="*,Auto" ColumnSpacing="8">
                                                <TextBlock Text="{Binding Name}" TextWrapping="Wrap" />
                                                <Button Grid.Column="1" Content="Открыть"
                                                        Command="{Binding DataContext.OpenArtifactCommand, ElementName=ArtifactsPanel}"
                                                        CommandParameter="{Binding}" />
                                            </Grid>
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                </ItemsControl>
                            </ScrollViewer>
                        </StackPanel>
                    </StackPanel>
                </Border>
            </StackPanel>
        </ScrollViewer>
    </Grid>
</UserControl>
