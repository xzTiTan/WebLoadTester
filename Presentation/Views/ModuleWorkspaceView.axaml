<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="clr-namespace:WebLoadTester.Presentation.ViewModels.Tabs"
             xmlns:root="clr-namespace:WebLoadTester.Presentation.ViewModels"
             xmlns:domain="clr-namespace:WebLoadTester.Core.Domain"
             x:Class="WebLoadTester.Presentation.Views.ModuleWorkspaceView"
             x:Name="Root"
             x:DataType="vm:ModuleFamilyViewModel">
    <Grid RowDefinitions="Auto,*" RowSpacing="16">
        <ContentControl x:Name="VmProxy"
                        Width="0"
                        Height="0"
                        IsVisible="False"
                        DataContext="{Binding DataContext, RelativeSource={RelativeSource AncestorType=Window}}" />

        <Border Grid.Row="0" Classes="app-bar">
            <Grid RowDefinitions="Auto,Auto,Auto,Auto" RowSpacing="12">
                <StackPanel Grid.Row="0"
                            Spacing="6"
                            DataContext="{Binding DataContext, ElementName=VmProxy}"
                            x:DataType="root:MainWindowViewModel">
                    <ProgressBar Minimum="0"
                                 Maximum="100"
                                 Height="6"
                                 Value="{Binding ProgressPercent}"
                                 IsIndeterminate="{Binding IsProgressIndeterminate}" />
                    <Grid ColumnDefinitions="Auto,*" ColumnSpacing="12">
                        <TextBlock Text="{Binding RunStage}" Classes="muted" />
                        <TextBlock Grid.Column="1"
                                   Text="{Binding ProgressText}"
                                   Classes="status-line"
                                   TextTrimming="CharacterEllipsis"
                                   MaxLines="1" />
                    </Grid>
                </StackPanel>

                <Grid Grid.Row="1"
                      ColumnDefinitions="*,Auto"
                      ColumnSpacing="16"
                      DataContext="{Binding DataContext, ElementName=VmProxy}"
                      x:DataType="root:MainWindowViewModel">
                    <TextBlock Text="Управление запуском" Classes="muted" VerticalAlignment="Center" />

                    <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="8" VerticalAlignment="Center" HorizontalAlignment="Right">
                        <StackPanel Orientation="Horizontal"
                                    Spacing="6"
                                    VerticalAlignment="Center"
                                    DataContext="{Binding RunProfile}"
                                    x:DataType="root:RunProfileViewModel"
                                    IsVisible="{Binding IsUiFamily}">
                            <TextBlock Text="Показывать браузер" VerticalAlignment="Center" />
                            <ToggleSwitch IsChecked="{Binding Headless, Converter={StaticResource BooleanNotConverter}, Mode=TwoWay}" />
                        </StackPanel>
                        <Button Content="Старт" Classes="primary toolbar-button" Command="{Binding StartCommand}" />
                        <Button Content="Перезапуск" Classes="toolbar-button" Command="{Binding RestartCommand}" />
                        <Button Content="Остановить" Classes="toolbar-button" Command="{Binding StopCommand}" />
                        <Button Content="Отмена" Classes="danger toolbar-button" Command="{Binding CancelCommand}" />
                    </StackPanel>
                </Grid>

                <StackPanel Grid.Row="2" Spacing="8">
                    <StackPanel Orientation="Horizontal" Spacing="8" VerticalAlignment="Center">
                        <TextBlock Text="Модули:" FontWeight="SemiBold" VerticalAlignment="Center" />
                        <ListBox ItemsSource="{Binding Modules}"
                                 SelectedItem="{Binding SelectedModule, Mode=TwoWay}"
                                 Classes="segmented-bar"
                                 BorderThickness="0">
                            <ListBox.ItemsPanel>
                                <ItemsPanelTemplate>
                                    <StackPanel Orientation="Horizontal" Spacing="8" />
                                </ItemsPanelTemplate>
                            </ListBox.ItemsPanel>
                            <ListBox.ItemTemplate>
                                <DataTemplate x:DataType="root:ModuleItemViewModel">
                                    <TextBlock Text="{Binding DisplayName}" />
                                </DataTemplate>
                            </ListBox.ItemTemplate>
                        </ListBox>
                    </StackPanel>

                    <StackPanel Spacing="4">
                        <TextBlock Text="{Binding SelectedModule.DisplayName}" Classes="section-title" FontSize="22" />
                        <TextBlock Text="{Binding SelectedModule.Description}" Classes="status-line" TextWrapping="Wrap" />
                        <TextBlock Text="Нажмите Старт для запуска. report.json создаётся всегда; report.html — по флагу."
                                   DataContext="{Binding DataContext, ElementName=VmProxy}"
                                   x:DataType="root:MainWindowViewModel"
                                   IsVisible="{Binding ShowRunHint}"
                                   TextWrapping="Wrap" />
                    </StackPanel>
                </StackPanel>

                <Border Grid.Row="3"
                        Classes="warning-panel"
                        DataContext="{Binding DataContext, ElementName=VmProxy}"
                        x:DataType="root:MainWindowViewModel"
                        IsVisible="{Binding ShowPlaywrightInstallBanner}">
                    <Grid ColumnDefinitions="*,Auto" ColumnSpacing="12">
                        <TextBlock Text="Chromium (Playwright) не установлен. UI сценарий завершится ошибкой, пока браузер не установлен."
                                   TextWrapping="Wrap" />
                        <StackPanel Grid.Column="1" Spacing="6" HorizontalAlignment="Right">
                            <Button Content="Install Chromium (Playwright)"
                                    Command="{Binding InstallPlaywrightBrowsersCommand}"
                                    IsEnabled="{Binding CanInstallPlaywright}" />
                            <TextBlock Text="{Binding PlaywrightInstallMessage}" Classes="status-line" TextWrapping="Wrap" />
                        </StackPanel>
                    </Grid>
                </Border>
            </Grid>
        </Border>

        <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto">
            <Grid ColumnDefinitions="*,*" ColumnSpacing="16" RowDefinitions="Auto,Auto,Auto" RowSpacing="16">
                <Border Grid.Row="0" Grid.Column="0" Classes="section" MinWidth="440" VerticalAlignment="Top">
                    <StackPanel Spacing="12"
                                DataContext="{Binding SelectedModule.ModuleConfig}"
                                x:DataType="root:ModuleConfigViewModel">
                        <Grid ColumnDefinitions="*,Auto" ColumnSpacing="8" ClipToBounds="True">
                            <TextBlock Text="Конфигурация"
                                       Classes="section-title"
                                       TextTrimming="CharacterEllipsis"
                                       TextWrapping="NoWrap"
                                       ClipToBounds="True" />
                            <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="8" HorizontalAlignment="Right">
                                <Button Classes="link toolbar-button" Content="Обновить" Command="{Binding RefreshCommand}" />
                                <Button Classes="link toolbar-button" Content="Загрузить" Command="{Binding LoadSelectedCommand}" />
                                <Button Classes="link toolbar-button" Content="Сохранить" Command="{Binding SaveNewCommand}" />
                                <Button Classes="link toolbar-button" Content="Перезаписать" Command="{Binding SaveOverwriteCommand}" />
                                <Button Classes="link toolbar-button" Content="Удалить" Command="{Binding RequestDeleteSelectedCommand}" />
                            </StackPanel>
                        </Grid>

                        <Grid ColumnDefinitions="{StaticResource FieldRowColumns}" Classes="field-row">
                            <TextBlock Text="Конфигурация" Classes="field-label" />
                            <ComboBox Classes="field-control"
                                      ItemsSource="{Binding Configs}"
                                      SelectedItem="{Binding SelectedConfig, Mode=TwoWay}">
                                <ComboBox.ItemTemplate>
                                    <DataTemplate x:DataType="domain:ModuleConfigSummary">
                                        <TextBlock Text="{Binding FinalName}" />
                                    </DataTemplate>
                                </ComboBox.ItemTemplate>
                            </ComboBox>
                        </Grid>
                        <StackPanel IsVisible="{Binding IsDeleteConfirmVisible}" Spacing="8">
                            <TextBlock Text="{Binding StatusMessage}" Foreground="OrangeRed" TextWrapping="Wrap" />
                            <StackPanel Orientation="Horizontal" Spacing="8">
                                <Button Content="Подтвердить удаление" Command="{Binding ConfirmDeleteSelectedCommand}" />
                                <Button Content="Отмена" Classes="ghost" Command="{Binding CancelDeleteSelectedCommand}" />
                            </StackPanel>
                        </StackPanel>
                        <Grid ColumnDefinitions="{StaticResource FieldRowColumns}" Classes="field-row">
                            <TextBlock Text="Имя (без пробелов)" Classes="field-label" />
                            <TextBox Classes="field-control" Watermark="Например: DemoConfig" Text="{Binding UserName, Mode=TwoWay}" />
                        </Grid>
                        <Grid ColumnDefinitions="{StaticResource FieldRowColumns}" Classes="field-row">
                            <TextBlock Text="Финальное имя" Classes="field-label" />
                            <TextBlock Classes="field-control" Text="{Binding FinalNamePreview}" />
                        </Grid>
                        <Grid ColumnDefinitions="{StaticResource FieldRowColumns}" Classes="field-row">
                            <TextBlock Text="Описание" Classes="field-label" />
                            <TextBox Classes="field-control" Watermark="Опишите назначение конфигурации" Text="{Binding Description, Mode=TwoWay}" />
                        </Grid>
                        <TextBlock Text="{Binding StatusMessage}" Classes="status-line" />
                    </StackPanel>
                </Border>

                <Border Grid.Row="0" Grid.Column="1" Classes="section" VerticalAlignment="Top" MinWidth="560">
                    <StackPanel Spacing="12">
                        <Grid ColumnDefinitions="*" ClipToBounds="True">
                            <TextBlock Text="Настройки модуля"
                                       Classes="section-title"
                                       TextTrimming="CharacterEllipsis"
                                       TextWrapping="NoWrap" />
                        </Grid>
                        <ContentControl Content="{Binding SelectedModule.SettingsViewModel}" />
                    </StackPanel>
                </Border>

                <Border Grid.Row="1" Grid.ColumnSpan="2" Classes="section"
                        DataContext="{Binding DataContext, ElementName=VmProxy}"
                        x:DataType="root:MainWindowViewModel">
                    <StackPanel Spacing="8" DataContext="{Binding RunProfile}" x:DataType="root:RunProfileViewModel">
                        <Grid ColumnDefinitions="*" ClipToBounds="True">
                            <TextBlock Text="Параметры запуска"
                                       Classes="section-title"
                                       TextTrimming="CharacterEllipsis"
                                       TextWrapping="NoWrap" />
                        </Grid>
                        <Grid ColumnDefinitions="{StaticResource FieldRowColumns}" Classes="field-row">
                            <TextBlock Text="Параллельность" Classes="field-label" />
                            <NumericUpDown Classes="field-control" Minimum="1" Value="{Binding Parallelism, Mode=TwoWay}" />
                        </Grid>
                        <Grid ColumnDefinitions="{StaticResource FieldRowColumns}" Classes="field-row">
                            <TextBlock Text="Режим" Classes="field-label" />
                            <ComboBox Classes="field-control" ItemsSource="{Binding ModeOptions}" SelectedItem="{Binding Mode, Mode=TwoWay}" />
                        </Grid>
                        <Grid ColumnDefinitions="{StaticResource FieldRowColumns}" Classes="field-row" IsVisible="{Binding IsIterationsMode}">
                            <TextBlock Text="Итерации" Classes="field-label" />
                            <NumericUpDown Classes="field-control" Minimum="1" Value="{Binding Iterations, Mode=TwoWay}" />
                        </Grid>
                        <Grid ColumnDefinitions="{StaticResource FieldRowColumns}" Classes="field-row" IsVisible="{Binding IsDurationMode}">
                            <TextBlock Text="Длительность (сек)" Classes="field-label" />
                            <NumericUpDown Classes="field-control" Minimum="10" Maximum="60" Value="{Binding DurationSeconds, Mode=TwoWay}" />
                        </Grid>
                        <Grid ColumnDefinitions="{StaticResource FieldRowColumns}" Classes="field-row">
                            <TextBlock Text="Таймаут (сек)" Classes="field-label" />
                            <NumericUpDown Classes="field-control" Minimum="5" Value="{Binding TimeoutSeconds, Mode=TwoWay}" />
                        </Grid>
                        <Grid ColumnDefinitions="{StaticResource FieldRowColumns}" Classes="field-row" IsVisible="{Binding IsUiFamily}">
                            <TextBlock Text="Скриншоты" Classes="field-label" />
                            <ComboBox Classes="field-control" ItemsSource="{Binding ScreenshotsPolicyOptions}" SelectedItem="{Binding ScreenshotsPolicy, Mode=TwoWay}">
                                <ComboBox.ItemTemplate>
                                    <DataTemplate x:DataType="domain:ScreenshotsPolicy">
                                        <TextBlock Text="{Binding ., Converter={StaticResource ScreenshotsPolicyDisplayConverter}}" />
                                    </DataTemplate>
                                </ComboBox.ItemTemplate>
                            </ComboBox>
                        </Grid>
                        <Grid ColumnDefinitions="{StaticResource FieldRowColumns}" Classes="field-row">
                            <TextBlock Text="HTML-отчёт" Classes="field-label" />
                            <ToggleSwitch Classes="field-control" IsChecked="{Binding HtmlReportEnabled, Mode=TwoWay}" />
                        </Grid>
                        <Grid ColumnDefinitions="{StaticResource FieldRowColumns}" Classes="field-row">
                            <TextBlock Text="Telegram" Classes="field-label" />
                            <ToggleSwitch Classes="field-control" IsChecked="{Binding TelegramEnabled, Mode=TwoWay}" />
                        </Grid>
                        <Grid ColumnDefinitions="{StaticResource FieldRowColumns}" Classes="field-row">
                            <TextBlock Text="Preflight" Classes="field-label" />
                            <ToggleSwitch Classes="field-control" IsChecked="{Binding PreflightEnabled, Mode=TwoWay}" />
                        </Grid>
                        <Border Classes="warning-panel" IsVisible="{Binding HasWarning}">
                            <TextBlock Text="{Binding WarningMessage}" />
                        </Border>
                        <TextBlock Text="{Binding StatusMessage}" Classes="status-line" />
                    </StackPanel>
                </Border>

                <Border Grid.Row="2" Grid.ColumnSpan="2" Classes="section">
                    <StackPanel Spacing="12">
                        <Grid ColumnDefinitions="*,Auto" ClipToBounds="True">
                            <TextBlock Text="Последний отчёт" Classes="section-title" TextTrimming="CharacterEllipsis" MaxLines="1" />
                            <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="4"
                                        DataContext="{Binding DataContext, ElementName=VmProxy}"
                                        x:DataType="root:MainWindowViewModel">
                                <Button Classes="link" Content="Открыть JSON" Command="{Binding OpenLatestJsonCommand}" />
                                <Button Classes="link" Content="Открыть HTML" Command="{Binding OpenLatestHtmlCommand}" />
                                <Button Classes="link" Content="Открыть папку прогона" Command="{Binding OpenLatestRunFolderCommand}" />
                            </StackPanel>
                        </Grid>

                        <StackPanel Classes="empty-state"
                                    IsVisible="{Binding SelectedModule.HasReport, Converter={StaticResource BooleanNotConverter}}">
                            <TextBlock Text="Нет данных" Classes="empty-title" />
                            <TextBlock Text="Выберите прогон или выполните запуск" />
                        </StackPanel>

                        <ContentControl Content="{Binding SelectedModule.LastReport}"
                                        IsVisible="{Binding SelectedModule.HasReport}">
                            <ContentControl.ContentTemplate>
                                <DataTemplate x:DataType="domain:TestReport">
                                    <Grid ColumnDefinitions="Auto,*" RowDefinitions="Auto,Auto,Auto,Auto,Auto" ColumnSpacing="12" RowSpacing="6">
                                        <TextBlock Text="Статус" Classes="muted" />
                                        <TextBlock Grid.Column="1" Text="{Binding Status}" />
                                        <TextBlock Grid.Row="1" Text="Длительность" Classes="muted" />
                                        <TextBlock Grid.Row="1" Grid.Column="1" Text="{Binding TotalDurationText}" />
                                        <TextBlock Grid.Row="2" Text="Ошибки" Classes="muted" />
                                        <TextBlock Grid.Row="2" Grid.Column="1" Text="{Binding Metrics.FailedItems}" />
                                        <TextBlock Grid.Row="3" Text="Среднее" Classes="muted" />
                                        <TextBlock Grid.Row="3" Grid.Column="1" Text="{Binding AverageText}" />
                                        <TextBlock Grid.Row="4" Text="P95" Classes="muted" />
                                        <TextBlock Grid.Row="4" Grid.Column="1" Text="{Binding P95Text}" />
                                    </Grid>
                                </DataTemplate>
                            </ContentControl.ContentTemplate>
                        </ContentControl>

                        <DataGrid ItemsSource="{Binding SelectedModule.DisplayResults}"
                                  Classes="list-min-180"
                                  MaxHeight="360"
                                  IsVisible="{Binding SelectedModule.HasReport}">
                            <DataGrid.Columns>
                                <DataGridTextColumn Header="Тип" Binding="{Binding Kind}" Width="140" />
                                <DataGridTemplateColumn Header="Название" Width="2*">
                                    <DataGridTemplateColumn.CellTemplate>
                                        <DataTemplate x:DataType="domain:ResultBase">
                                            <TextBlock Text="{Binding ., Converter={StaticResource ResultDisplayNameConverter}}" />
                                        </DataTemplate>
                                    </DataGridTemplateColumn.CellTemplate>
                                </DataGridTemplateColumn>
                                <DataGridTextColumn Header="Успех" Binding="{Binding Success}" Width="120" />
                                <DataGridTextColumn Header="Длительность, мс" Binding="{Binding DurationMs}" Width="160" />
                                <DataGridTextColumn Header="Ошибка" Binding="{Binding ErrorMessage}" Width="2*" />
                            </DataGrid.Columns>
                        </DataGrid>

                        <ItemsControl DataContext="{Binding DataContext, ElementName=VmProxy}"
                                      x:DataType="root:MainWindowViewModel"
                                      IsVisible="{Binding SelectedModule.HasReport}"
                                      ItemsSource="{Binding SelectedModule.ArtifactItems}">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate x:DataType="root:ArtifactListItem">
                                    <Grid ColumnDefinitions="*,Auto" ColumnSpacing="8" Margin="0,0,0,8">
                                        <TextBlock Text="{Binding Name}" TextWrapping="Wrap" />
                                        <Button Grid.Column="1" Content="Открыть"
                                                Command="{Binding $parent[ItemsControl].DataContext.OpenArtifactCommand}"
                                                CommandParameter="{Binding}" />
                                    </Grid>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </StackPanel>
                </Border>
            </Grid>
        </ScrollViewer>
    </Grid>
</UserControl>
