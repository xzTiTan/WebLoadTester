<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="clr-namespace:WebLoadTester.Presentation.ViewModels.Tabs"
             xmlns:root="clr-namespace:WebLoadTester.Presentation.ViewModels"
             xmlns:domain="clr-namespace:WebLoadTester.Core.Domain"
             x:Class="WebLoadTester.Presentation.Views.ModuleWorkspaceView"
             x:Name="Root"
             x:DataType="vm:ModuleFamilyViewModel">
    <ScrollViewer VerticalScrollBarVisibility="Auto">
        <StackPanel Spacing="16">
            <Border Classes="section">
                <StackPanel Spacing="8">
                    <TextBlock Text="Выбор модуля" Classes="section-title" />
                    <Grid ColumnDefinitions="{StaticResource FieldRowColumns}" Classes="field-row">
                        <TextBlock Text="Модуль" Classes="field-label" />
                        <ComboBox Classes="field-control"
                                  ItemsSource="{Binding Modules}"
                                  SelectedItem="{Binding SelectedModule, Mode=TwoWay}">
                            <ComboBox.ItemTemplate>
                                <DataTemplate x:DataType="root:ModuleItemViewModel">
                                    <TextBlock Text="{Binding DisplayName}" />
                                </DataTemplate>
                            </ComboBox.ItemTemplate>
                        </ComboBox>
                    </Grid>
                    <TextBlock Text="{Binding SelectedModule.Description}" Classes="status-line" />
                </StackPanel>
            </Border>

            <Border Classes="section">
                <StackPanel Spacing="8">
                    <Grid ColumnDefinitions="*,Auto">
                        <TextBlock Text="Тесты (Test Library)" Classes="section-title" />
                        <StackPanel Grid.Column="1" Classes="section-actions">
                            <Button Content="Обновить"
                                    Command="{Binding SelectedModule.TestLibrary.RefreshCommand}" />
                            <Button Content="Загрузить"
                                    Command="{Binding SelectedModule.TestLibrary.LoadSelectedCommand}" />
                            <Button Content="Сохранить"
                                    Command="{Binding SelectedModule.TestLibrary.SaveCurrentCommand}" />
                            <Button Content="Сохранить как"
                                    Command="{Binding SelectedModule.TestLibrary.SaveAsCommand}" />
                            <Button Content="Удалить"
                                    Command="{Binding SelectedModule.TestLibrary.RequestDeleteSelectedCommand}" />
                        </StackPanel>
                    </Grid>
                    <Grid ColumnDefinitions="{StaticResource FieldRowColumns}" Classes="field-row">
                        <TextBlock Text="Тест" Classes="field-label" />
                        <ComboBox Classes="field-control"
                                  ItemsSource="{Binding SelectedModule.TestLibrary.TestCases}"
                                  SelectedItem="{Binding SelectedModule.TestLibrary.SelectedTestCase, Mode=TwoWay}" />
                    </Grid>
                    <StackPanel IsVisible="{Binding SelectedModule.TestLibrary.IsDeleteConfirmVisible}" Spacing="8">
                        <TextBlock Text="{Binding SelectedModule.TestLibrary.StatusMessage}" Foreground="OrangeRed" TextWrapping="Wrap" />
                        <StackPanel Classes="section-actions">
                            <Button Content="Подтвердить удаление"
                                    Command="{Binding SelectedModule.TestLibrary.ConfirmDeleteSelectedCommand}" />
                            <Button Content="Отмена"
                                    Command="{Binding SelectedModule.TestLibrary.CancelDeleteSelectedCommand}" />
                        </StackPanel>
                    </StackPanel>
                    <Grid ColumnDefinitions="{StaticResource FieldRowColumns}" Classes="field-row">
                        <TextBlock Text="Название теста" Classes="field-label" />
                        <TextBox Classes="field-control" Text="{Binding SelectedModule.TestLibrary.TestName, Mode=TwoWay}" />
                    </Grid>
                    <Grid ColumnDefinitions="{StaticResource FieldRowColumns}" Classes="field-row">
                        <TextBlock Text="Описание" Classes="field-label" />
                        <TextBox Classes="field-control" Text="{Binding SelectedModule.TestLibrary.TestDescription, Mode=TwoWay}" />
                    </Grid>
                    <Grid ColumnDefinitions="{StaticResource FieldRowColumns}" Classes="field-row">
                        <TextBlock Text="Комментарий к версии" Classes="field-label" />
                        <TextBox Classes="field-control" Text="{Binding SelectedModule.TestLibrary.ChangeNote, Mode=TwoWay}" />
                    </Grid>
                    <TextBlock Text="{Binding SelectedModule.TestLibrary.StatusMessage}" Classes="status-line" />
                </StackPanel>
            </Border>

            <ContentControl Content="{Binding SelectedModule.SettingsViewModel}" />

            <Border Classes="section">
                <StackPanel Spacing="8"
                            DataContext="{Binding DataContext, RelativeSource={RelativeSource AncestorType=Window}}"
                            x:DataType="root:MainWindowViewModel">
                    <StackPanel Spacing="8"
                                DataContext="{Binding RunProfile}"
                                x:DataType="root:RunProfileViewModel">
                        <Grid ColumnDefinitions="*,Auto">
                            <TextBlock Text="Профиль запуска" Classes="section-title" />
                            <StackPanel Grid.Column="1" Classes="section-actions">
                                <Button Content="Обновить" Command="{Binding RefreshCommand}" />
                                <Button Content="Сохранить профиль"
                                        Command="{Binding SaveProfileCommand}" />
                                <Button Content="Сохранить как"
                                        Command="{Binding SaveAsProfileCommand}" />
                                <Button Content="Удалить"
                                        Command="{Binding RequestDeleteProfileCommand}" />
                            </StackPanel>
                        </Grid>
                        <Grid ColumnDefinitions="{StaticResource FieldRowColumns}" Classes="field-row">
                            <TextBlock Text="Профиль" Classes="field-label" />
                            <ComboBox Classes="field-control"
                                      ItemsSource="{Binding Profiles}"
                                      SelectedItem="{Binding SelectedProfile, Mode=TwoWay}">
                            <ComboBox.ItemTemplate>
                                <DataTemplate x:DataType="domain:RunProfile">
                                    <TextBlock Text="{Binding Name}" />
                                </DataTemplate>
                            </ComboBox.ItemTemplate>
                            </ComboBox>
                        </Grid>
                        <StackPanel IsVisible="{Binding IsDeleteConfirmVisible}" Spacing="8">
                            <TextBlock Text="{Binding StatusMessage}" Foreground="OrangeRed" TextWrapping="Wrap" />
                            <StackPanel Classes="section-actions">
                                <Button Content="Подтвердить удаление"
                                        Command="{Binding ConfirmDeleteProfileCommand}" />
                                <Button Content="Отмена"
                                        Command="{Binding CancelDeleteProfileCommand}" />
                            </StackPanel>
                        </StackPanel>
                        <Grid ColumnDefinitions="{StaticResource FieldRowColumns}" Classes="field-row">
                            <TextBlock Text="Название профиля" Classes="field-label" />
                            <TextBox Classes="field-control" Text="{Binding ProfileName, Mode=TwoWay}" />
                        </Grid>
                        <Grid ColumnDefinitions="{StaticResource FieldRowColumns}" Classes="field-row">
                            <TextBlock Text="Parallelism" Classes="field-label" />
                            <NumericUpDown Classes="field-control" Minimum="1" Value="{Binding Parallelism, Mode=TwoWay}" />
                        </Grid>
                        <Grid ColumnDefinitions="{StaticResource FieldRowColumns}" Classes="field-row">
                            <TextBlock Text="Режим" Classes="field-label" />
                            <ComboBox Classes="field-control"
                                      ItemsSource="{Binding ModeOptions}"
                                      SelectedItem="{Binding Mode, Mode=TwoWay}" />
                        </Grid>
                        <Grid ColumnDefinitions="{StaticResource FieldRowColumns}" Classes="field-row">
                            <TextBlock Text="Iterations" Classes="field-label" />
                            <NumericUpDown Classes="field-control" Minimum="1" Value="{Binding Iterations, Mode=TwoWay}" />
                        </Grid>
                        <Grid ColumnDefinitions="{StaticResource FieldRowColumns}" Classes="field-row">
                            <TextBlock Text="Duration (sec)" Classes="field-label" />
                            <NumericUpDown Classes="field-control" Minimum="10" Value="{Binding DurationSeconds, Mode=TwoWay}" />
                        </Grid>
                        <Grid ColumnDefinitions="{StaticResource FieldRowColumns}" Classes="field-row">
                            <TextBlock Text="Timeout (sec)" Classes="field-label" />
                            <NumericUpDown Classes="field-control" Minimum="5" Value="{Binding TimeoutSeconds, Mode=TwoWay}" />
                        </Grid>
                        <Grid ColumnDefinitions="{StaticResource FieldRowColumns}" Classes="field-row">
                            <TextBlock Text="Headless" Classes="field-label" />
                            <CheckBox Classes="field-control" Content="Включено" IsChecked="{Binding Headless, Mode=TwoWay}" />
                        </Grid>
                        <Grid ColumnDefinitions="{StaticResource FieldRowColumns}" Classes="field-row">
                            <TextBlock Text="Screenshots policy" Classes="field-label" />
                            <ComboBox Classes="field-control"
                                      ItemsSource="{Binding ScreenshotsPolicyOptions}"
                                      SelectedItem="{Binding ScreenshotsPolicy, Mode=TwoWay}" />
                        </Grid>
                        <Grid ColumnDefinitions="{StaticResource FieldRowColumns}" Classes="field-row">
                            <TextBlock Text="HTML отчёт" Classes="field-label" />
                            <CheckBox Classes="field-control" Content="Включено" IsChecked="{Binding HtmlReportEnabled, Mode=TwoWay}" />
                        </Grid>
                        <Grid ColumnDefinitions="{StaticResource FieldRowColumns}" Classes="field-row">
                            <TextBlock Text="Telegram" Classes="field-label" />
                            <CheckBox Classes="field-control" Content="Отправлять статус" IsChecked="{Binding TelegramEnabled, Mode=TwoWay}" />
                        </Grid>
                        <Grid ColumnDefinitions="{StaticResource FieldRowColumns}" Classes="field-row">
                            <TextBlock Text="Preflight" Classes="field-label" />
                            <CheckBox Classes="field-control" Content="Включено" IsChecked="{Binding PreflightEnabled, Mode=TwoWay}" />
                        </Grid>
                        <TextBlock Text="{Binding WarningMessage}" Foreground="OrangeRed" TextWrapping="Wrap" />
                        <TextBlock Text="{Binding StatusMessage}" Classes="status-line" />
                    </StackPanel>
                </StackPanel>
            </Border>

            <Border Classes="section">
                <StackPanel Spacing="8"
                            DataContext="{Binding DataContext, RelativeSource={RelativeSource AncestorType=Window}}"
                            x:DataType="root:MainWindowViewModel">
                    <Grid ColumnDefinitions="*,Auto">
                        <TextBlock Text="Управление запуском" Classes="section-title" />
                        <StackPanel Grid.Column="1" Classes="section-actions">
                            <Button Content="Start" Command="{Binding StartCommand}" />
                            <Button Content="Stop" Command="{Binding StopCommand}" />
                            <Button Content="Cancel" Command="{Binding StopCommand}" />
                        </StackPanel>
                    </Grid>
                    <TextBlock Text="{Binding RunStage}" />
                    <ProgressBar Minimum="0" Maximum="100"
                                 IsIndeterminate="{Binding IsRunning}" />
                    <TextBlock Text="{Binding ProgressText}" Classes="status-line" />
                </StackPanel>
            </Border>

            <Border Classes="section">
                <StackPanel Spacing="8">
                    <TextBlock Text="Итоговая сводка" Classes="section-title" />
                    <StackPanel Classes="empty-state"
                                IsVisible="{Binding SelectedModule.HasReport, Converter={StaticResource BooleanNotConverter}}">
                        <TextBlock Text="Нет данных" Classes="empty-title" />
                        <TextBlock Text="Выберите прогон или выполните запуск" />
                    </StackPanel>
                    <ContentControl Content="{Binding SelectedModule.LastReport}"
                                    IsVisible="{Binding SelectedModule.HasReport}">
                        <ContentControl.ContentTemplate>
                            <DataTemplate x:DataType="domain:TestReport">
                                <StackPanel>
                                    <TextBlock Text="{Binding Status}" />
                                    <TextBlock Text="{Binding Metrics.TotalDurationMs, StringFormat='Duration: {0:F0} ms'}" />
                                    <TextBlock Text="{Binding Metrics.FailedItems, StringFormat='Failed items: {0}'}" />
                                    <TextBlock Text="{Binding Metrics.AverageMs, StringFormat='Avg: {0:F1} ms'}" />
                                    <TextBlock Text="{Binding Metrics.P95Ms, StringFormat='P95: {0:F1} ms'}" />
                                </StackPanel>
                            </DataTemplate>
                        </ContentControl.ContentTemplate>
                    </ContentControl>
                </StackPanel>
            </Border>

            <Border Classes="section">
                <StackPanel Spacing="8">
                    <TextBlock Text="Детальные результаты" Classes="section-title" />
                    <StackPanel Classes="empty-state"
                                IsVisible="{Binding SelectedModule.HasReport, Converter={StaticResource BooleanNotConverter}}">
                        <TextBlock Text="Нет данных" Classes="empty-title" />
                        <TextBlock Text="Выберите прогон или выполните запуск" />
                    </StackPanel>
                    <DataGrid ItemsSource="{Binding SelectedModule.LastReport.Results}"
                              Classes="list-min-180"
                              IsVisible="{Binding SelectedModule.HasReport}">
                        <DataGrid.Columns>
                            <DataGridTextColumn Header="Kind" Binding="{Binding Kind}" Width="*" />
                            <DataGridTemplateColumn Header="Name" Width="2*">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate x:DataType="domain:ResultBase">
                                        <TextBlock Text="{Binding ., Converter={StaticResource ResultDisplayNameConverter}}" />
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                            </DataGridTemplateColumn>
                            <DataGridTextColumn Header="Success" Binding="{Binding Success}" Width="*" />
                            <DataGridTextColumn Header="Duration (ms)" Binding="{Binding DurationMs}" Width="*" />
                            <DataGridTextColumn Header="Error" Binding="{Binding ErrorMessage}" Width="2*" />
                        </DataGrid.Columns>
                    </DataGrid>
                </StackPanel>
            </Border>

            <Border Classes="section">
                <StackPanel Spacing="8"
                            DataContext="{Binding DataContext, RelativeSource={RelativeSource AncestorType=Window}}"
                            x:DataType="root:MainWindowViewModel">
                    <Grid ColumnDefinitions="*,Auto">
                        <TextBlock Text="Артефакты" Classes="section-title" />
                        <StackPanel Grid.Column="1" Classes="section-actions">
                            <Button Content="Открыть JSON" Command="{Binding OpenLatestJsonCommand}" />
                            <Button Content="Открыть HTML" Command="{Binding OpenLatestHtmlCommand}" />
                            <Button Content="Открыть папку прогона" Command="{Binding OpenLatestRunFolderCommand}" />
                        </StackPanel>
                    </Grid>
                </StackPanel>
            </Border>

            <Border Classes="section">
                <StackPanel Spacing="8"
                            DataContext="{Binding DataContext, RelativeSource={RelativeSource AncestorType=Window}}"
                            x:DataType="root:MainWindowViewModel">
                    <TextBlock Text="Лог выполнения" Classes="section-title" />
                    <Border Classes="log-box" MinHeight="160">
                        <ListBox ItemsSource="{Binding LogEntries}"
                                 Classes="loglist">
                            <ListBox.ItemTemplate>
                                <DataTemplate>
                                    <TextBlock Classes="logline" Text="{Binding}" />
                                </DataTemplate>
                            </ListBox.ItemTemplate>
                        </ListBox>
                    </Border>
                </StackPanel>
            </Border>
        </StackPanel>
    </ScrollViewer>
</UserControl>
